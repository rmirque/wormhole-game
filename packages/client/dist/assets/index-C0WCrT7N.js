(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();class d{x;y;constructor(t,e){this.x=t,this.y=e}static zero(){return new d(0,0)}static fromAngle(t){return new d(Math.cos(t),Math.sin(t))}add(t){return new d(this.x+t.x,this.y+t.y)}sub(t){return new d(this.x-t.x,this.y-t.y)}mul(t){return new d(this.x*t,this.y*t)}div(t){return new d(this.x/t,this.y/t)}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}normalize(){const t=this.length();return t===0?new d(0,0):this.div(t)}clamp(t){return this.length()>t?this.normalize().mul(t):new d(this.x,this.y)}lerp(t,e){return new d(this.x+(t.x-this.x)*e,this.y+(t.y-this.y)*e)}clone(){return new d(this.x,this.y)}dot(t){return this.x*t.x+this.y*t.y}}const F=1e3/60,et=.06,xt=.12,gt=.992,ot=5,b=12,$="#33ff33",n=1200,a=800,yt="#001100",mt="#0a330a",st=50,St=1.5,R=4,Z=3,bt=180,it=15,wt="#33ff33";class Et{position;velocity;angle;previousPosition;previousAngle;thrusting=!1;rotatingLeft=!1;rotatingRight=!1;cargo=new Array(R).fill(null);lives=Z;invulnerabilityTimer=0;isDead=!1;speedBoost=1;color;constructor(t,e,s=wt){this.position=new d(t,e),this.velocity=d.zero(),this.angle=-Math.PI/2,this.color=s,this.previousPosition=this.position.clone(),this.previousAngle=this.angle}savePreviousState(){this.previousPosition=this.position.clone(),this.previousAngle=this.angle}update(){if(!this.isDead){if(this.rotatingLeft&&(this.angle-=et),this.rotatingRight&&(this.angle+=et),this.thrusting){const t=d.fromAngle(this.angle).mul(xt*this.speedBoost);this.velocity=this.velocity.add(t)}this.velocity=this.velocity.clamp(ot*this.speedBoost),this.velocity=this.velocity.mul(gt),this.position=this.position.add(this.velocity),this.wrapPosition(),this.invulnerabilityTimer>0&&this.invulnerabilityTimer--,this.speedBoost=1}}isInvulnerable(){return this.invulnerabilityTimer>0}isVisible(){return this.isInvulnerable()?Math.floor(Date.now()/100)%2===0:!0}takeDamage(){return this.isInvulnerable()||this.isDead?!1:(this.lives--,this.invulnerabilityTimer=bt,this.clearCargo(),this.lives<=0?(this.isDead=!0,!0):!1)}applySpeedBoost(t){this.speedBoost=Math.max(this.speedBoost,t)}reset(t,e){this.position=new d(t,e),this.previousPosition=this.position.clone(),this.velocity=d.zero(),this.angle=-Math.PI/2,this.previousAngle=this.angle,this.lives=Z,this.invulnerabilityTimer=0,this.isDead=!1,this.cargo.fill(null),this.speedBoost=1}wrapPosition(){this.position.x<0?(this.position.x+=n,this.previousPosition.x+=n):this.position.x>n&&(this.position.x-=n,this.previousPosition.x-=n),this.position.y<0?(this.position.y+=a,this.previousPosition.y+=a):this.position.y>a&&(this.position.y-=a,this.previousPosition.y-=a)}getInterpolatedPosition(t){return this.previousPosition.lerp(this.position,t)}getInterpolatedAngle(t){return this.previousAngle+(this.angle-this.previousAngle)*t}getCargoCount(){return this.cargo.filter(t=>t!==null).length}isCargoFull(){return this.getCargoCount()>=R}isCargoEmpty(){return this.getCargoCount()===0}addCargo(t){const e=this.cargo.findIndex(s=>s===null);return e===-1?!1:(this.cargo[e]=t,!0)}clearCargo(){const t=this.cargo.filter(e=>e!==null);return this.cargo.fill(null),t}removeCargoAt(t){if(t<0||t>=R)return null;const e=this.cargo[t];return this.cargo[t]=null,e}getCargo(){return[...this.cargo]}}const V=80,j=120,vt=.018;class nt{position;rotation=0;pulsePhase=0;pulseSpeed=.05;constructor(){this.position=new d(n/2,a/2)}update(){this.rotation+=vt,this.pulsePhase+=this.pulseSpeed}getRotation(){return this.rotation}getTargetAngle(t=1,e=0){if(t<=0)return this.rotation;const s=Math.PI*2/t;return this.rotation+s*e}getPulseIntensity(){return(Math.sin(this.pulsePhase)+1)/2}isInBankingZone(t){return t.sub(this.position).length()<=j}isInWormhole(t){return t.sub(this.position).length()<=V}}const Q=12,kt=.08,Tt=3;var l=(c=>(c.RED="red",c.BLUE="blue",c.GREEN="green",c.GOLD="gold",c))(l||{});const B={red:"#ff4444",blue:"#4444ff",green:"#44ff44",gold:"#ffcc00"},Rt={red:"rgba(255, 68, 68, 0.5)",blue:"rgba(68, 68, 255, 0.5)",green:"rgba(68, 255, 68, 0.5)",gold:"rgba(255, 204, 0, 0.6)"},Pt={red:.4,blue:.35,green:.2,gold:.05};class K{position;type;bobPhase;id;static nextId=0;constructor(t,e){this.id=K.nextId++,this.position=t,this.type=e,this.bobPhase=Math.random()*Math.PI*2}update(){this.bobPhase+=kt}getVisualY(){return this.position.y+Math.sin(this.bobPhase)*Tt}getBobIntensity(){return(Math.sin(this.bobPhase)+1)/2}collidesWith(t,e){return this.position.sub(t).length()<=e+Q}static getRandomType(){const t=Math.random();let e=0;for(const[s,i]of Object.entries(Pt))if(e+=i,t<=e)return s;return"red"}}var P=(c=>(c.ASTEROID="asteroid",c.SEEKER="seeker",c.MINE="mine",c.NUKE="nuke",c))(P||{});let N=0;class at{id;type="asteroid";position;velocity;radius;lifetime;maxLifetime=900;active=!0;rotation=0;rotationSpeed;isLarge=!1;constructor(t,e,s=!1){this.id=N++,this.position=t,this.velocity=e,this.isLarge=s,this.radius=s?35:20,this.lifetime=this.maxLifetime,this.rotation=Math.random()*Math.PI*2,this.rotationSpeed=(Math.random()-.5)*.1}update(){this.active&&(this.position=this.position.add(this.velocity),this.rotation+=this.rotationSpeed,this.position.x<this.radius?(this.position.x=this.radius,this.velocity.x=Math.abs(this.velocity.x)):this.position.x>n-this.radius&&(this.position.x=n-this.radius,this.velocity.x=-Math.abs(this.velocity.x)),this.position.y<this.radius?(this.position.y=this.radius,this.velocity.y=Math.abs(this.velocity.y)):this.position.y>a-this.radius&&(this.position.y=a-this.radius,this.velocity.y=-Math.abs(this.velocity.y)),this.lifetime--)}collidesWith(t,e){return this.active?this.position.sub(t).length()<=this.radius+e:!1}isExpired(){return this.lifetime<=0}}class Mt{id;type="seeker";position;velocity;radius=12;lifetime;maxLifetime=1200;active=!0;wobblePhase=0;maxSpeed;constructor(t){this.id=N++,this.position=t,this.maxSpeed=ot*.6,this.velocity=d.zero(),this.lifetime=this.maxLifetime,this.wobblePhase=Math.random()*Math.PI*2}targetShip=null;setTarget(t){this.targetShip=t}update(){if(!this.active)return;const t=this.targetShip;if(!t)return;this.wobblePhase+=.1;const e=t.position.sub(this.position);if(e.length()>0){let i=e.normalize();const r=.3,o=Math.cos(this.wobblePhase)*r,h=Math.sin(this.wobblePhase*1.3)*r;i=new d(i.x+o,i.y+h).normalize(),this.velocity=i.mul(this.maxSpeed)}this.position=this.position.add(this.velocity),this.position.x<0&&(this.position.x+=n),this.position.x>n&&(this.position.x-=n),this.position.y<0&&(this.position.y+=a),this.position.y>a&&(this.position.y-=a),this.lifetime--}collidesWith(t,e){return this.active?this.position.sub(t).length()<=this.radius+e:!1}isExpired(){return this.lifetime<=0}}class At{id;type="mine";position;velocity=d.zero();radius=10;armingRadius=60;lifetime;maxLifetime=1800;armingTime=120;active=!0;armed=!1;blinkPhase=0;constructor(t){this.id=N++,this.position=t,this.lifetime=this.maxLifetime}update(){this.active&&(this.armed?this.blinkPhase+=.2:(this.armingTime--,this.armingTime<=0&&(this.armed=!0)),this.lifetime--)}collidesWith(t,e){return this.active?this.armed?this.position.sub(t).length()<=this.armingRadius+e:this.position.sub(t).length()<=this.radius+e:!1}isExpired(){return this.lifetime<=0}getBlinkAlpha(){return this.armed?(Math.sin(this.blinkPhase)+1)/2*.8+.2:0}}class Ct{id;type="nuke";position;velocity=d.zero();radius=0;maxRadius=375;lifetime;countdownTime=300;detonated=!1;explosionTime=0;maxExplosionTime=120;active=!0;safeZoneRadius=50;constructor(t){this.id=N++,this.position=t,this.lifetime=this.countdownTime+this.maxExplosionTime}update(){if(this.active){if(!this.detonated)this.countdownTime--,this.countdownTime<=0&&this.detonate();else{this.explosionTime++;const t=this.explosionTime/this.maxExplosionTime;this.radius=this.maxRadius*Math.min(t*1.5,1),this.explosionTime>=this.maxExplosionTime&&(this.active=!1)}this.lifetime--}}detonate(){this.detonated=!0,this.explosionTime=0}collidesWith(t,e){if(!this.active||!this.detonated||t.sub(this.position).length()<=this.safeZoneRadius)return!1;const i=[new d(0,0),new d(n,0),new d(0,a),new d(n,a)];for(const o of i)if(t.sub(o).length()<80)return!1;return this.position.sub(t).length()<=this.radius+e}isExpired(){return this.lifetime<=0}getCountdownSeconds(){return Math.ceil(this.countdownTime/60)}}class J{id;position;radius=100;lifetime=600;maxLifetime=600;active=!0;boostMultiplier=1.5;constructor(t,e=!1){this.id=N++,this.position=t,e&&(this.radius=150,this.boostMultiplier=2,this.lifetime=900,this.maxLifetime=900)}update(){this.lifetime--,this.lifetime<=0&&(this.active=!1)}contains(t){return this.active?this.position.sub(t).length()<=this.radius:!1}isExpired(){return this.lifetime<=0}getIntensity(){return this.lifetime/this.maxLifetime}}class Ot{canvas;ctx;offsetX=0;offsetY=0;constructor(t){const e=document.getElementById(t);if(!e)throw new Error(`Canvas element with id '${t}' not found`);this.canvas=e;const s=e.getContext("2d");if(!s)throw new Error("Could not get 2D rendering context");this.ctx=s,this.canvas.width=n,this.canvas.height=a,this.canvas.style.border="2px solid #1a1f3a",this.canvas.style.borderRadius="4px"}setOffset(t,e){this.offsetX=t,this.offsetY=e}clear(){this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.fillStyle=yt,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore(),this.ctx.save(),this.ctx.translate(this.offsetX,this.offsetY)}renderGrid(){this.ctx.fillStyle=mt;for(let e=0;e<n;e+=st)for(let s=0;s<a;s+=st)this.ctx.beginPath(),this.ctx.arc(e,s,St,0,Math.PI*2),this.ctx.fill();this.ctx.strokeStyle="#1a4a1a",this.ctx.lineWidth=2,this.ctx.strokeRect(0,0,n,a);const t=30;this.ctx.strokeStyle="#0d330d",this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.moveTo(0,t),this.ctx.lineTo(0,0),this.ctx.lineTo(t,0),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(n-t,0),this.ctx.lineTo(n,0),this.ctx.lineTo(n,t),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(0,a-t),this.ctx.lineTo(0,a),this.ctx.lineTo(t,a),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(n-t,a),this.ctx.lineTo(n,a),this.ctx.lineTo(n,a-t),this.ctx.stroke()}renderWormhole(t,e){const s=e?.3+t.getPulseIntensity()*.4:0;this.ctx.save(),this.ctx.translate(t.position.x,t.position.y),this.ctx.shadowBlur=20+s*20,this.ctx.shadowColor="#33ff33",this.ctx.strokeStyle=`rgba(51, 255, 51, ${.3+s*.4})`,this.ctx.lineWidth=2,this.ctx.setLineDash([10,5]),this.ctx.beginPath(),this.ctx.arc(0,0,j,0,Math.PI*2),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.shadowBlur=30,this.ctx.shadowColor="#00ff00",this.ctx.rotate(t.getRotation());for(let h=3;h>0;h--){const f=V*(h/3),u=.2+s*.3;this.ctx.strokeStyle=`rgba(51, 255, 51, ${u})`,this.ctx.lineWidth=2,this.ctx.strokeRect(-f,-f,f*2,f*2),this.ctx.rotate(Math.PI/8)}this.ctx.fillStyle=`rgba(0, 255, 0, ${.6+s*.4})`,this.ctx.shadowBlur=40,this.ctx.fillRect(-15,-15,30,30),this.ctx.restore(),this.ctx.save(),this.ctx.translate(t.position.x,t.position.y);const i=t.getTargetAngle(1,0);this.ctx.rotate(i),this.ctx.strokeStyle="#ff3333",this.ctx.shadowBlur=10,this.ctx.shadowColor="#ff3333",this.ctx.lineWidth=2;const r=V+25,o=15;this.ctx.beginPath(),this.ctx.moveTo(r-o,-o),this.ctx.lineTo(r,-o),this.ctx.lineTo(r,o),this.ctx.lineTo(r-o,o),this.ctx.stroke(),this.ctx.restore()}renderOrb(t){const e=t.getVisualY(),s=t.getBobIntensity();this.ctx.save(),this.ctx.translate(t.position.x,e),this.ctx.shadowBlur=8+s*6,this.ctx.shadowColor=B[t.type],this.ctx.fillStyle="#001100";const i=Q*2;this.ctx.fillRect(-i/2,-i/2,i,i),this.ctx.strokeStyle=B[t.type],this.ctx.lineWidth=2,this.ctx.strokeRect(-i/2,-i/2,i,i),this.ctx.shadowBlur=4,this.renderOrbPixelIcon(t.type),this.ctx.restore()}renderOrbPixelIcon(t){this.ctx.fillStyle=B[t],this.ctx.shadowColor=B[t];const e=(s,i)=>{this.ctx.fillRect(s*3-6,i*3-6,3,3)};switch(t){case l.RED:e(1,0),e(2,0),e(0,1),e(3,1),e(1,2),e(2,2);break;case l.BLUE:e(1,0),e(0,1),e(2,1),e(1,1),e(1,2);break;case l.GREEN:e(1,0),e(1,1),e(1,2),e(1,3),e(0,1),e(2,1);break;case l.GOLD:e(1,0),e(0,1),e(1,2),e(2,1),e(1,1);break}}renderShip(t,e,s,i=!0,r=1){this.ctx.save(),this.ctx.translate(t.x,t.y),this.ctx.rotate(e),this.ctx.globalAlpha=i?r:.3,this.ctx.shadowBlur=15*r,this.ctx.shadowColor=$,this.ctx.fillStyle=$,this.ctx.strokeStyle=$,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(b,0),this.ctx.lineTo(-b*.7,b*.7),this.ctx.lineTo(-b*.4,0),this.ctx.lineTo(-b*.7,-b*.7),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),this.ctx.shadowBlur=0,s&&(this.ctx.shadowBlur=10*r,this.ctx.shadowColor="#ffaa00",this.ctx.fillStyle="#ffaa00",this.ctx.beginPath(),this.ctx.moveTo(-b*.4,0),this.ctx.lineTo(-b*1.2,b*.4),this.ctx.lineTo(-b*1.5,0),this.ctx.lineTo(-b*1.2,-b*.4),this.ctx.closePath(),this.ctx.fill(),this.ctx.shadowBlur=0),this.ctx.restore()}renderShipWithWrap(t,e,s,i=!0){this.renderShip(t,e,s,i,1);const r=b*1.5,o=f=>Math.min(1,f/r)*.4;if(t.x<r){const f=o(t.x);this.renderShip(new d(t.x+n,t.y),e,s,i,f)}if(t.x>n-r){const f=o(n-t.x);this.renderShip(new d(t.x-n,t.y),e,s,i,f)}if(t.y<r){const f=o(t.y);this.renderShip(new d(t.x,t.y+a),e,s,i,f)}if(t.y>a-r){const f=o(a-t.y);this.renderShip(new d(t.x,t.y-a),e,s,i,f)}const h=b;if(t.x<h&&t.y<h){const f=Math.min(o(t.x),o(t.y));this.renderShip(new d(t.x+n,t.y+a),e,s,i,f)}if(t.x>n-h&&t.y<h){const f=Math.min(o(n-t.x),o(t.y));this.renderShip(new d(t.x-n,t.y+a),e,s,i,f)}if(t.x<h&&t.y>a-h){const f=Math.min(o(t.x),o(a-t.y));this.renderShip(new d(t.x+n,t.y-a),e,s,i,f)}if(t.x>n-h&&t.y>a-h){const f=Math.min(o(n-t.x),o(a-t.y));this.renderShip(new d(t.x-n,t.y-a),e,s,i,f)}}renderParticles(t){for(const e of t.particles)this.ctx.save(),this.ctx.globalAlpha=e.alpha,this.ctx.fillStyle=e.color,this.ctx.beginPath(),this.ctx.arc(e.position.x,e.position.y,e.size,0,Math.PI*2),this.ctx.fill(),this.ctx.restore()}renderHUD(t,e,s,i){for(let p=0;p<Z;p++){const S=10+p*28;p<t.lives?(this.ctx.fillStyle="#ff4444",this.drawHeart(S+20/2,40+20/2,20/2)):(this.ctx.strokeStyle="#444444",this.ctx.lineWidth=2,this.drawHeartOutline(S+20/2,40+20/2,20/2))}const u=32,x=8,E=R*u+(R-1)*x,v=(n-E)/2,y=a-50,k=t.getCargo();for(let p=0;p<R;p++){const S=v+p*(u+x),w=k[p];if(this.ctx.strokeStyle="#4a4a6a",this.ctx.lineWidth=2,this.ctx.fillStyle="#1a1a2a",this.ctx.beginPath(),this.ctx.roundRect(S,y,u,u,4),this.ctx.fill(),this.ctx.stroke(),w){const T=S+u/2,g=y+u/2;this.ctx.fillStyle=Rt[w],this.ctx.beginPath(),this.ctx.arc(T,g,u/2+2,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle=B[w],this.ctx.beginPath(),this.ctx.arc(T,g,u/2-2,0,Math.PI*2),this.ctx.fill()}}if(this.ctx.fillStyle="#ffffff",this.ctx.font="14px monospace",this.ctx.textAlign="left",this.ctx.fillText(`FPS: ${e}`,10,20),this.ctx.fillStyle="#aaaaaa",this.ctx.font="12px monospace",this.ctx.textAlign="center",this.ctx.fillText(`CARGO (${t.getCargoCount()}/${R})`,n/2,y-10),s&&i&&i>0){const p=Math.min(i,1);this.ctx.save(),this.ctx.globalAlpha=p,this.ctx.fillStyle=s.tier>=3?"#ff8800":s.tier>=2?"#ff44ff":"#44ffff",this.ctx.font="bold 24px monospace",this.ctx.textAlign="center",this.ctx.fillText(s.description,n/2,100),this.ctx.restore()}!t.isCargoEmpty()&&!t.isDead&&(this.ctx.fillStyle="#00ffff",this.ctx.font="14px monospace",this.ctx.textAlign="center",this.ctx.fillText("Press SPACE to bank orbs!",n/2,a-80)),this.ctx.textAlign="left"}drawHeart(t,e,s){this.ctx.beginPath(),this.ctx.moveTo(t,e+s/4),this.ctx.quadraticCurveTo(t,e-s/2,t-s,e),this.ctx.quadraticCurveTo(t-s*1.5,e+s/2,t,e+s),this.ctx.quadraticCurveTo(t+s*1.5,e+s/2,t+s,e),this.ctx.quadraticCurveTo(t,e-s/2,t,e+s/4),this.ctx.fill()}drawHeartOutline(t,e,s){this.ctx.beginPath(),this.ctx.moveTo(t,e+s/4),this.ctx.quadraticCurveTo(t,e-s/2,t-s,e),this.ctx.quadraticCurveTo(t-s*1.5,e+s/2,t,e+s),this.ctx.quadraticCurveTo(t+s*1.5,e+s/2,t+s,e),this.ctx.quadraticCurveTo(t,e-s/2,t,e+s/4),this.ctx.stroke()}renderBankingIndicator(t,e,s){this.ctx.save(),this.ctx.translate(t.x,t.y);const i=e+Math.sin(Date.now()/200)*5;this.ctx.strokeStyle=`rgba(0, 255, 255, ${.3+s*.4})`,this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(0,0,i,0,Math.PI*2),this.ctx.stroke(),this.ctx.restore()}renderHazard(t){if(t.active){switch(this.ctx.save(),this.ctx.translate(t.position.x,t.position.y),t.type){case P.ASTEROID:this.renderAsteroid(t);break;case P.SEEKER:this.renderSeeker(t);break;case P.MINE:this.renderMine(t);break;case P.NUKE:this.renderNuke(t);break}this.ctx.restore()}}renderAsteroid(t){this.ctx.save(),this.ctx.rotate(t.rotation),this.ctx.fillStyle="#8B7355",this.ctx.strokeStyle="#5C4033",this.ctx.lineWidth=2,this.ctx.beginPath();const e=t.radius;for(let s=0;s<8;s++){const i=s/8*Math.PI*2,r=e*(.8+Math.random()*.4),o=Math.cos(i)*r,h=Math.sin(i)*r;s===0?this.ctx.moveTo(o,h):this.ctx.lineTo(o,h)}this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),this.ctx.restore()}renderSeeker(t){const e=this.ctx.createRadialGradient(0,0,5,0,0,25);e.addColorStop(0,"rgba(100, 150, 255, 0.8)"),e.addColorStop(1,"rgba(100, 150, 255, 0)"),this.ctx.fillStyle=e,this.ctx.beginPath(),this.ctx.arc(0,0,25,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#4488ff",this.ctx.beginPath(),this.ctx.arc(0,0,t.radius,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle=`rgba(100, 200, 255, ${.5+Math.sin(Date.now()/100)*.3})`,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(0,0,t.radius+5,0,Math.PI*2),this.ctx.stroke()}renderMine(t){if(!t.armed)return;const e=t.getBlinkAlpha(),s=this.ctx.createRadialGradient(0,0,0,0,0,t.armingRadius);s.addColorStop(0,`rgba(255, 100, 100, ${e*.3})`),s.addColorStop(1,"rgba(255, 100, 100, 0)"),this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(0,0,t.armingRadius,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle=`rgba(255, 0, 0, ${e})`,this.ctx.beginPath(),this.ctx.arc(0,0,4,0,Math.PI*2),this.ctx.fill()}renderNuke(t){if(t.detonated){const e=this.ctx.createRadialGradient(0,0,0,0,0,t.radius);e.addColorStop(0,"rgba(255, 255, 200, 0.9)"),e.addColorStop(.3,"rgba(255, 200, 100, 0.7)"),e.addColorStop(.7,"rgba(255, 100, 50, 0.4)"),e.addColorStop(1,"rgba(255, 50, 0, 0)"),this.ctx.fillStyle=e,this.ctx.beginPath(),this.ctx.arc(0,0,t.radius,0,Math.PI*2),this.ctx.fill()}else{const e=t.getCountdownSeconds();this.ctx.fillStyle="#ff0000",this.ctx.font="bold 30px monospace",this.ctx.textAlign="center",this.ctx.fillText(`NUKE IN ${e}`,0,-40);const s=(Math.sin(Date.now()/50)+1)/2;this.ctx.strokeStyle=`rgba(255, 0, 0, ${.5+s*.5})`,this.ctx.lineWidth=4,this.ctx.beginPath(),this.ctx.arc(0,0,30+s*20,0,Math.PI*2),this.ctx.stroke()}}renderBoostZone(t){if(!t.active)return;const e=t.getIntensity();this.ctx.save(),this.ctx.translate(t.position.x,t.position.y);const s=this.ctx.createRadialGradient(0,0,0,0,0,t.radius);s.addColorStop(0,`rgba(100, 255, 150, ${.1*e})`),s.addColorStop(.5,`rgba(100, 255, 150, ${.05*e})`),s.addColorStop(1,"rgba(100, 255, 150, 0)"),this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(0,0,t.radius,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle=`rgba(100, 255, 150, ${.3*e})`,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(0,0,t.radius,0,Math.PI*2),this.ctx.stroke(),this.ctx.restore()}renderGameOver(t){this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(0,0,n,a),this.ctx.fillStyle="#ff4444",this.ctx.font="bold 60px monospace",this.ctx.textAlign="center",this.ctx.fillText("GAME OVER",n/2,a/2-50),this.ctx.fillStyle="#ffffff",this.ctx.font="24px monospace",this.ctx.fillText("You ran out of lives!",n/2,a/2+10),t&&(this.ctx.fillStyle="#00ff88",this.ctx.font="20px monospace",this.ctx.fillText("Press SPACE to restart",n/2,a/2+60))}renderQuadrantView(t,e,s,i,r,o,h,f){const u=this.canvas.width,x=this.canvas.height,E=10,v=15,y=35,k=50,p=y,S=x-y-k,w=Math.floor((u-E*2-v)*.65),T=u-E*2-v-w,g=Math.floor((S-(t.length-2)*v)/(t.length-1));this.ctx.fillStyle="#001100",this.ctx.fillRect(0,0,u,x),this.ctx.fillStyle="rgba(51, 255, 51, 0.1)",this.ctx.fillRect(0,0,u,y-5),this.ctx.strokeStyle="#33ff33",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(0,y-5),this.ctx.lineTo(u,y-5),this.ctx.stroke();const m=E+w+v/2;this.ctx.strokeStyle="#1a4a1a",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(m,p),this.ctx.lineTo(m,p+S),this.ctx.stroke(),this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(E,p,w,S),this.ctx.clip();const G=w/n,O=S/a,W=Math.min(G,O),ct=(w-n*W)/2,lt=(S-a*W)/2;this.ctx.translate(E+ct,p+lt),this.ctx.scale(W,W),this.renderGridState(e,s,i,!0),this.ctx.restore();const _=t.filter(I=>!I.isPlayer),U=E+w+v;let D=p;for(let I=0;I<_.length;I++){const A=_[I],C=Math.min(g,(S-(_.length-1)*v)/_.length);this.ctx.strokeStyle=A.ship.color,this.ctx.lineWidth=2,this.ctx.strokeRect(U-2,D-2,T+4,C+4),this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(U,D,T,C),this.ctx.clip();const dt=(T-10)/n,ft=(C-10)/a,H=Math.min(dt,ft),ut=(T-n*H)/2,pt=(C-a*H)/2;this.ctx.translate(U+ut,D+pt),this.ctx.scale(H,H),this.renderGridState(A,[],i,!1),this.ctx.restore(),this.ctx.fillStyle=A.ship.color,this.ctx.font="12px VT323, monospace",this.ctx.textAlign="left",this.ctx.fillText(`${A.owner.toUpperCase().replace("-","-")} [${A.ship.lives}â™¥ ${A.ship.getCargoCount()}/4]`,U,D+C+14),D+=C+v+20}this.renderMultiplayerHUD(e,r,o,h,f,E,w,x,y,k)}renderGridState(t,e,s,i){if(t.screenShake>0){const r=(Math.random()-.5)*t.screenShake,o=(Math.random()-.5)*t.screenShake;this.ctx.translate(r,o)}this.ctx.fillStyle="#001100",this.ctx.fillRect(0,0,n,a),i&&this.renderGrid();for(const r of t.boostZones)this.renderBoostZone(r);for(const r of t.orbs.values())this.renderOrb(r);this.renderWormhole(t.wormhole,t.bankingPulse>.5);for(const r of t.hazards)this.renderHazard(r);if(!t.ship.isDead){const r=t.ship.getInterpolatedPosition(s),o=t.ship.getInterpolatedAngle(s);this.renderShipWithWrap(r,o,t.ship.thrusting,t.ship.isVisible())}if(i)for(const r of e)r.active&&this.renderBullet(r);i&&this.renderParticles(t.particles)}renderBullet(t){this.ctx.save(),this.ctx.translate(t.position.x,t.position.y),this.ctx.rotate(t.angle),this.ctx.shadowBlur=8,this.ctx.shadowColor="#ffff00",this.ctx.fillStyle="#ffff00",this.ctx.fillRect(-4,-2,8,4),this.ctx.fillStyle="#ffaa00",this.ctx.fillRect(-8,-1,4,2),this.ctx.restore()}renderMultiplayerHUD(t,e,s,i,r,o,h,f,u,x){this.ctx.shadowBlur=5,this.ctx.font="18px VT323, monospace",this.ctx.fillStyle="#33ff33",this.ctx.textAlign="left",this.ctx.fillText(`SYS: ONLINE | FPS: ${e}`,o,u-12);const E=this.canvas.width-o-80,v=u-20;for(let g=0;g<3;g++){const m=E+g*25;this.ctx.shadowBlur=10,this.ctx.shadowColor="#ff3333",g<t.ship.lives?(this.ctx.fillStyle="#ff3333",this.drawHeart(m+10,v+10,8)):(this.ctx.strokeStyle="#552222",this.ctx.lineWidth=2,this.drawHeartOutline(m+10,v+10,8))}if(this.ctx.shadowBlur=5,this.ctx.shadowColor="#ff3333",this.ctx.fillStyle="#ff3333",this.ctx.font="14px VT323, monospace",this.ctx.textAlign="right",this.ctx.fillText("LIVES:",E-5,u-12),s.length>0){this.ctx.textAlign="right";let g=u+25;for(const m of s)this.ctx.fillStyle=m.includes("WINS")?"#ffff33":"#ff3333",this.ctx.fillText(m,this.canvas.width-o,g),g+=22}const y=f-x+15,k=24,p=6,S=4*k+3*p,w=o+(h-S)/2;this.ctx.fillStyle="#1a991a",this.ctx.textAlign="center",this.ctx.fillText(`[ DATA BUFFER: ${t.ship.getCargoCount()}/4 ]`,o+h/2,y);const T=t.ship.getCargo();for(let g=0;g<4;g++){const m=w+g*(k+p),G=y+10,O=T[g];this.ctx.strokeStyle=O?"#33ff33":"#1a4a1a",this.ctx.lineWidth=2,this.ctx.strokeRect(m,G,k,k),O&&this.renderOrbIcon(m,G,k,O)}if(this.ctx.fillStyle="#888888",this.ctx.shadowBlur=0,this.ctx.font="12px VT323, monospace",this.ctx.fillText("[SPACE] FIRE  |  [1][2][3][4] UPLOAD SLOT",o+h/2,y+45),!t.ship.isDead&&t.bankingPulse>.3&&!t.ship.isCargoEmpty()&&(this.ctx.fillStyle="#00ffff",this.ctx.shadowBlur=15,this.ctx.shadowColor="#00ffff",this.ctx.font="16px VT323, monospace",this.ctx.fillText(">>> PRESS 1-4 TO UPLOAD DATA <<<",o+h/2,y-25),this.ctx.shadowBlur=5),i){this.ctx.fillStyle="rgba(0, 0, 0, 0.85)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const g=r==="player"?"PLAYER":r?.toUpperCase()||"UNKNOWN",m=r==="player";this.ctx.fillStyle=m?"#33ff33":"#ff3333",this.ctx.shadowBlur=25,this.ctx.shadowColor=m?"#33ff33":"#ff3333",this.ctx.font="bold 60px VT323, monospace",this.ctx.textAlign="center",this.ctx.fillText(m?"VICTORY!":"DEFEAT",this.canvas.width/2,this.canvas.height/2-40),this.ctx.fillStyle="#ffffff",this.ctx.font="28px VT323, monospace",this.ctx.fillText(`${g} WINS THE ROUND`,this.canvas.width/2,this.canvas.height/2+20),this.ctx.fillStyle="#00ffff",this.ctx.font="20px VT323, monospace",this.ctx.fillText("Press [SPACE] to restart simulation",this.canvas.width/2,this.canvas.height/2+70)}this.ctx.shadowBlur=0,this.ctx.textAlign="left"}renderOrbIcon(t,e,s,i){const r=t+s/2,o=e+s/2,h=3;switch(this.ctx.save(),i){case l.RED:this.ctx.shadowBlur=8,this.ctx.shadowColor="#ff4444",this.ctx.fillStyle="#ff4444";const f=[[0,1,0],[1,1,1],[1,0,1]];this.drawPixelPattern(r,o,h,f);break;case l.BLUE:this.ctx.shadowBlur=8,this.ctx.shadowColor="#4444ff",this.ctx.fillStyle="#4444ff";const u=[[0,1,0],[1,0,1],[0,1,0]];this.drawPixelPattern(r,o,h,u);break;case l.GREEN:this.ctx.shadowBlur=8,this.ctx.shadowColor="#44ff44",this.ctx.fillStyle="#44ff44";const x=[[0,1,0],[1,1,1],[0,1,0]];this.drawPixelPattern(r,o,h,x),this.ctx.fillRect(r-6,o-6,2,2),this.ctx.fillRect(r+4,o-6,2,2),this.ctx.fillRect(r-6,o+4,2,2),this.ctx.fillRect(r+4,o+4,2,2);break;case l.GOLD:this.ctx.shadowBlur=10,this.ctx.shadowColor="#ffcc00",this.ctx.fillStyle="#ffcc00",this.ctx.fillRect(r-2,o-2,4,4),this.ctx.fillRect(r-2,o-6,4,3),this.ctx.fillRect(r+3,o+2,3,4),this.ctx.fillRect(r-6,o+2,3,4);break}this.ctx.restore()}drawPixelPattern(t,e,s,i){const r=i.length,o=i[0].length,h=t-o*s/2,f=e-r*s/2;for(let u=0;u<r;u++)for(let x=0;x<o;x++)i[u][x]&&this.ctx.fillRect(h+x*s,f+u*s,s,s)}getCanvas(){return this.canvas}}class Dt{keys=new Set;actionPressed=!1;onThrustStart;onThrustEnd;onRotateLeftStart;onRotateLeftEnd;onRotateRightStart;onRotateRightEnd;onShoot;onBankSlot;constructor(){this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this),window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp)}destroy(){window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp)}handleKeyDown(t){const e=t.key.toLowerCase();if(["w","a","s","d"," ","1","2","3","4","arrowup","arrowleft","arrowright","arrowdown"].includes(e)&&t.preventDefault(),!this.keys.has(e))switch(this.keys.add(e),e){case"w":case"arrowup":this.onThrustStart?.();break;case"a":case"arrowleft":this.onRotateLeftStart?.();break;case"d":case"arrowright":this.onRotateRightStart?.();break;case"s":case"arrowdown":break;case" ":this.actionPressed=!0,this.onShoot?.();break;case"1":this.onBankSlot?.(0);break;case"2":this.onBankSlot?.(1);break;case"3":this.onBankSlot?.(2);break;case"4":this.onBankSlot?.(3);break}}handleKeyUp(t){const e=t.key.toLowerCase();switch(this.keys.delete(e),e){case"w":case"arrowup":this.onThrustEnd?.();break;case"a":case"arrowleft":this.onRotateLeftEnd?.();break;case"d":case"arrowright":this.onRotateRightEnd?.();break}}isPressed(t){return this.keys.has(t.toLowerCase())}isActionPressed(){const t=this.actionPressed;return this.actionPressed=!1,t}}class It{particles=[];createBurst(t,e,s=10,i=3,r=4,o=30){for(let h=0;h<s;h++){const f=Math.PI*2*h/s+Math.random()*.5,u=Math.random()*i+1,x=d.fromAngle(f).mul(u);this.particles.push({position:t.clone(),velocity:x,life:o,maxLife:o,size:r*(.5+Math.random()*.5),color:e,alpha:1})}}createCollectionBurst(t,e){this.createBurst(t,e,12,4,5,40)}createBankingBurst(t,e){this.createBurst(t,e,20,6,6,50)}update(){for(let t=this.particles.length-1;t>=0;t--){const e=this.particles[t];e.position=e.position.add(e.velocity),e.velocity=e.velocity.mul(.95),e.life--,e.alpha=e.life/e.maxLife,e.life<=0&&this.particles.splice(t,1)}}clear(){this.particles=[]}getCount(){return this.particles.length}}function q(c,t,e){const s={[l.RED]:0,[l.BLUE]:0,[l.GREEN]:0,[l.GOLD]:0};for(const i of c)s[i]++;if(s[l.GOLD]>=8)return{hazards:[_t(e)],boostZones:[],tier:4,description:"NUKE DETONATED!"};for(const i of[l.RED,l.BLUE,l.GREEN])if(s[i]>=4)return Gt(i,t,e);if(s[l.RED]>=1&&s[l.BLUE]>=1&&s[l.GREEN]>=1)return Lt(t,e);for(const i of[l.RED,l.BLUE,l.GREEN])if(s[i]>=3)return Nt(i,t,e);for(const i of[l.RED,l.BLUE,l.GREEN])if(s[i]>=2)return Bt(i,t,e);return s[l.RED]>=1?X(l.RED,t,e):s[l.BLUE]>=1?X(l.BLUE,t,e):s[l.GREEN]>=1?X(l.GREEN,t,e):{hazards:[],boostZones:[],tier:1,description:"Nothing happened..."}}function X(c,t,e){const s=[],i=[];let r="";switch(c){case l.RED:for(let o=0;o<3;o++)s.push(M(e,!1));r="3 Asteroids spawned!";break;case l.BLUE:s.push(L(t,e)),r="Seeker Drone launched!";break;case l.GREEN:i.push(new J(e,!1)),r="Speed Boost Zone created!";break}return{hazards:s,boostZones:i,tier:1,description:r}}function Bt(c,t,e){const s=[],i=[];let r="";switch(c){case l.RED:for(let o=0;o<3;o++)s.push(M(e,!1));for(let o=0;o<2;o++)s.push(M(e,!0));r="Enhanced Asteroid Swarm!";break;case l.BLUE:for(let o=0;o<2;o++)s.push(L(t,e));r="Twin Seekers launched!";break;case l.GREEN:i.push(new J(e,!0)),r="Enhanced Speed Zone!";break}return{hazards:s,boostZones:i,tier:1.5,description:r}}function Nt(c,t,e){const s=[],i=[];let r="";switch(c){case l.RED:s.push(...Wt()),r="ASTEROID WALL!";break;case l.BLUE:for(let o=0;o<3;o++)s.push(L(t,e));r="Seeker Swarm!";break;case l.GREEN:for(let o=0;o<8;o++)s.push(Y(e));r="MINE FIELD deployed!";break}return{hazards:s,boostZones:i,tier:2,description:r}}function Lt(c,t){const e=[];return e.push(M(t,!1)),e.push(M(t,!0)),e.push(L(c,t)),e.push(Y(t)),e.push(Y(t)),{hazards:e,boostZones:[],tier:2,description:"CHAOS STORM!"}}function Gt(c,t,e){const s=[],i=[];let r="";switch(c){case l.RED:for(let o=0;o<8;o++)s.push(M(e,!1));for(let o=0;o<4;o++)s.push(M(e,!0));r="MEGA ASTEROID BARRAGE!";break;case l.BLUE:for(let o=0;o<5;o++)s.push(L(t,e));r="MEGA SEEKER SWARM!";break;case l.GREEN:for(let o=0;o<12;o++)s.push(Y(e));i.push(new J(e,!0)),r="MEGA DEFENSE GRID!";break}return{hazards:s,boostZones:i,tier:3,description:r}}function M(c,t){const e=Ut(),s=Math.random()*Math.PI*2,i=1+Math.random()*2,r=d.fromAngle(s).mul(i);return new at(e,r,t)}function Wt(c){const t=[],e=Math.floor(Math.random()*4),s=8;let i=0,r=0,o;switch(e){case 0:i=n/2-200,r=50,o=new d(0,2+Math.random());break;case 1:i=n-50,r=a/2-200,o=new d(-(2+Math.random()),0);break;case 2:i=n/2-200,r=a-50,o=new d(0,-(2+Math.random()));break;case 3:i=50,r=a/2-200,o=new d(2+Math.random(),0);break}const h=(e%2===0,60);for(let f=0;f<s;f++){const u=e%2===0?i+f*h:i,x=e%2===1?r+f*h:r;t.push(new at(new d(u,x),o.clone(),f%3===0))}return t}function L(c,t){const e=ht(t,150),s=new Mt(e);return s.setTarget(c),s}function Y(c){const t=ht(c,250);return new At(t)}function _t(c){return new Ct(c)}function Ut(c,t){const e=Math.floor(Math.random()*4);let s=0,i=0;switch(e){case 0:s=Math.random()*n,i=30;break;case 1:s=n-30,i=Math.random()*a;break;case 2:s=Math.random()*n,i=a-30;break;case 3:s=30,i=Math.random()*a;break}return new d(s,i)}function ht(c,t){const e=Math.random()*Math.PI*2,s=t+Math.random()*200;return new d(c.x+Math.cos(e)*s,c.y+Math.sin(e)*s)}class rt{owner;isPlayer;ship;wormhole;orbs=new Map;hazards=[];boostZones=[];particles;orbSpawnTimer=0;nextOrbSpawnTime=3e3;MAX_ORBS=12;MIN_SPAWN_DISTANCE=150;MIN_EDGE_DISTANCE=50;SPAWN_INTERVAL_MIN=2e3;SPAWN_INTERVAL_MAX=4e3;bankingPulse=0;lastAttackResult=null;attackMessageTimer=0;ATTACK_MESSAGE_DURATION=180;screenShake=0;SCREEN_SHAKE_DECAY=.9;gameOver=!1;gameOverTimer=0;winner=null;onBankOrbs;onShipDestroyed;onKillFeed;constructor(t,e){this.owner=t.owner,this.isPlayer=t.isPlayer,this.ship=new Et(t.shipStartX,t.shipStartY,t.shipColor),this.wormhole=e||new nt,this.particles=new It}update(){if(this.gameOver){this.gameOverTimer++,this.particles.update();return}this.ship.savePreviousState(),this.ship.update(),this.wormhole&&this.wormhole.update();for(const t of this.orbs.values())t.update();for(const t of this.hazards)t.type,t.update();for(const t of this.boostZones)t.update();this.particles.update(),this.updateOrbSpawning(),this.checkCollisions(),this.checkBoostZones(),this.attackMessageTimer>0&&this.attackMessageTimer--,!this.ship.isDead&&this.wormhole.isInBankingZone(this.ship.position)?this.bankingPulse=Math.min(this.bankingPulse+.05,1):this.bankingPulse=Math.max(this.bankingPulse-.05,0),this.screenShake*=this.SCREEN_SHAKE_DECAY,this.screenShake<.5&&(this.screenShake=0),this.hazards=this.hazards.filter(t=>!t.isExpired()&&t.active),this.boostZones=this.boostZones.filter(t=>!t.isExpired()&&t.active),this.ship.isDead&&!this.gameOver&&this.handleGameOver()}bankOrbs(){if(this.wormhole.isInBankingZone(this.ship.position)&&!this.ship.isCargoEmpty()){const t=this.ship.clearCargo();this.particles.createBankingBurst(this.wormhole.position,"#00ffff");for(const s of t){const i=this.getOrbColor(s);this.particles.createBurst(this.wormhole.position,i,5,2,3,25)}this.onBankOrbs?.(this.owner,t);const e=q(t,this.ship,this.wormhole.position);this.lastAttackResult=e,this.attackMessageTimer=this.ATTACK_MESSAGE_DURATION,e.tier>=3?this.screenShake=20:e.tier>=2?this.screenShake=10:this.screenShake=5}}spawnAttack(t,e){this.hazards.push(...t.hazards),this.boostZones.push(...t.boostZones);for(const i of this.hazards)i.type==="seeker"&&i.setTarget(this.ship);const s=e==="player"?"Player":e.toUpperCase();this.lastAttackResult={...t,description:`${s}: ${t.description}`},this.attackMessageTimer=this.ATTACK_MESSAGE_DURATION,t.tier>=3?this.screenShake=20:t.tier>=2?this.screenShake=10:this.screenShake=5}updateOrbSpawning(){this.orbs.size>=this.MAX_ORBS||(this.orbSpawnTimer+=F,this.orbSpawnTimer>=this.nextOrbSpawnTime&&(this.spawnOrb(),this.orbSpawnTimer=0,this.nextOrbSpawnTime=this.SPAWN_INTERVAL_MIN+Math.random()*(this.SPAWN_INTERVAL_MAX-this.SPAWN_INTERVAL_MIN)))}spawnOrb(){let t=0;const e=50;for(;t<e;){const s=this.MIN_EDGE_DISTANCE+Math.random()*(n-this.MIN_EDGE_DISTANCE*2),i=this.MIN_EDGE_DISTANCE+Math.random()*(a-this.MIN_EDGE_DISTANCE*2),r=new d(s,i),o=new d(n/2,a/2);if(r.sub(o).length()>=this.MIN_SPAWN_DISTANCE){let h=!1;for(const f of this.orbs.values())if(r.sub(f.position).length()<Q*3){h=!0;break}if(!h){const f=K.getRandomType(),u=new K(r,f);this.orbs.set(u.id,u);return}}t++}}checkCollisions(){for(const[t,e]of this.orbs.entries())if(e.collidesWith(this.ship.position,it)&&this.ship.addCargo(e.type)){const s=this.getOrbColor(e.type);this.particles.createCollectionBurst(e.position,s),this.orbs.delete(t)}if(!this.ship.isInvulnerable()){for(const t of this.hazards)if(t.collidesWith(this.ship.position,it)){this.handleShipHit(t);break}}}checkBoostZones(){for(const t of this.boostZones)t.contains(this.ship.position)&&this.ship.applySpeedBoost(t.boostMultiplier)}handleShipHit(t){if(this.particles.createBurst(this.ship.position,"#ff4400",20,5,8,40),this.screenShake=15,this.ship.takeDamage()){this.particles.createBurst(this.ship.position,"#ff0000",50,8,12,80);const s=t.type==="seeker"?"Seeker Drone":t.type==="asteroid"?"Asteroid":t.type==="mine"?"Mine":t.type==="nuke"?"NUKE":"Unknown";this.onKillFeed?.(`${this.getDisplayName()} was destroyed by ${s}`),this.onShipDestroyed?.(this.owner)}}handleGameOver(){this.gameOver=!0}markWinner(){this.winner=this.owner,this.gameOver=!0}reset(){this.ship.reset(n/2,a/2+200),this.hazards=[],this.boostZones=[],this.orbs.clear(),this.particles.clear(),this.gameOver=!1,this.gameOverTimer=0,this.screenShake=0,this.lastAttackResult=null,this.attackMessageTimer=0,this.winner=null,this.orbSpawnTimer=0}getDisplayName(){return this.isPlayer?"Player":this.owner.toUpperCase().replace("-","-")}getOrbColor(t){switch(t){case l.RED:return"#ff4444";case l.BLUE:return"#4444ff";case l.GREEN:return"#44ff44";case l.GOLD:return"#ffcc00";default:return"#ffffff"}}}const Ht={easy:{difficulty:"easy",reactionDelay:250,steeringAccuracy:.7,bankThreshold:.8,evadeDistance:100},medium:{difficulty:"medium",reactionDelay:133,steeringAccuracy:.85,bankThreshold:.6,evadeDistance:150},hard:{difficulty:"hard",reactionDelay:33,steeringAccuracy:.97,bankThreshold:.4,evadeDistance:200}};class z{grid;config;currentState="collect";stateTimer=0;lastDecisionTime=0;pendingAction=null;targetOrb=null;targetPosition=null;static CORNERS=[new d(50,50),new d(n-50,50),new d(50,a-50),new d(n-50,a-50)];constructor(t,e){this.grid=t,this.config=e,this.lastDecisionTime=performance.now()}update(){if(this.grid.ship.isDead||this.grid.gameOver){this.stopShip();return}const t=performance.now();this.checkStateTransitions(),t-this.lastDecisionTime>=this.config.reactionDelay&&(this.executeStateBehavior(),this.lastDecisionTime=t),this.applyMovement()}checkStateTransitions(){const t=this.grid.ship,e=this.grid.hazards,s=t.getCargoCount()/R;if(e.find(o=>o.type===P.NUKE&&!o.detonated)){this.currentState!=="flee_nuke"&&(this.currentState="flee_nuke",this.targetPosition=this.findNearestCorner());return}const r=this.findNearestHazard();if(r&&r.distance<this.config.evadeDistance){this.currentState!=="evade"&&(this.currentState="evade",this.targetPosition=this.calculateEscapeVector(r.hazard));return}if(s>=this.config.bankThreshold){this.currentState!=="bank"&&(this.currentState="bank",this.targetPosition=this.grid.wormhole.position);return}this.currentState!=="collect"&&(this.currentState="collect",this.targetOrb=null)}executeStateBehavior(){switch(this.currentState){case"collect":this.executeCollect();break;case"bank":this.executeBank();break;case"evade":this.executeEvade();break;case"flee_nuke":this.executeFleeNuke();break}}executeCollect(){const t=this.grid.ship;let e=null,s=1/0;for(const i of this.grid.orbs.values()){const r=i.position.sub(t.position).length();r<s&&(s=r,e=i)}if(e)this.targetOrb=e,this.steerToward(e.position);else{const i=Date.now()/2e3,r=new d(n/2+Math.cos(i)*300,a/2+Math.sin(i)*300);this.steerToward(r)}}executeBank(){const t=this.grid.ship,e=this.grid.wormhole;t.position.sub(e.position).length()<j?(this.grid.bankOrbs(),this.currentState="collect"):this.steerToward(e.position)}executeEvade(){const t=this.findNearestHazard();if(!t||t.distance>this.config.evadeDistance*1.5){this.currentState="collect";return}const e=this.calculateEscapeVector(t.hazard);this.steerToward(e)}executeFleeNuke(){if(!this.grid.hazards.find(e=>e.type===P.NUKE&&!e.detonated)){this.currentState="collect";return}this.targetPosition=this.findNearestCorner(),this.targetPosition&&(this.grid.ship.position.sub(this.targetPosition).length()<30?this.stopShip():this.steerToward(this.targetPosition))}steerToward(t){const e=this.grid.ship,s=t.sub(e.position);let r=Math.atan2(s.y,s.x)-e.angle;for(;r>Math.PI;)r-=Math.PI*2;for(;r<-Math.PI;)r+=Math.PI*2;const o=this.config.steeringAccuracy,h=r*o+(Math.random()-.5)*.1*(1-o);Math.abs(h)>.1?(e.rotatingLeft=h<0,e.rotatingRight=h>0):(e.rotatingLeft=!1,e.rotatingRight=!1);const f=s.length(),u=Math.abs(r);e.thrusting=u<Math.PI/3||f>400}applyMovement(){}stopShip(){this.grid.ship.thrusting=!1,this.grid.ship.rotatingLeft=!1,this.grid.ship.rotatingRight=!1}findNearestHazard(){let t=null,e=1/0;for(const s of this.grid.hazards){if(!s.active)continue;const i=s.position.sub(this.grid.ship.position).length();i<e&&(e=i,t=s)}return t?{hazard:t,distance:e}:null}calculateEscapeVector(t){const e=this.grid.ship;let s=e.position.sub(t.position);return s.length()<10&&(s=d.fromAngle(Math.random()*Math.PI*2)),s=s.normalize(),e.position.add(s.mul(200))}findNearestCorner(){let t=z.CORNERS[0],e=1/0;for(const s of z.CORNERS){const i=s.sub(this.grid.ship.position).length();i<e&&(e=i,t=s)}return t}getStateName(){return this.currentState}}const Ft=12,Kt=40,Yt=3;class tt{position;velocity;angle;lifetime=Kt;active=!0;id;static nextId=0;constructor(t,e){this.id=tt.nextId++,this.position=t.clone(),this.angle=e,this.velocity=d.fromAngle(e).mul(Ft)}update(){this.active&&(this.position=this.position.add(this.velocity),this.lifetime--,this.position.x<0&&(this.position.x+=n),this.position.x>n&&(this.position.x-=n),this.position.y<0&&(this.position.y+=a),this.position.y>a&&(this.position.y-=a),this.lifetime<=0&&(this.active=!1))}collidesWith(t,e){return this.active?this.position.sub(t).length()<=Yt+e:!1}isExpired(){return this.lifetime<=0||!this.active}}class zt{renderer;input;sharedWormhole;grids=new Map;playerGrid;bots=new Map;numBots=2;bullets=[];lastShotTime=0;SHOOT_COOLDOWN=150;lastTime=0;accumulator=0;running=!1;frameCount=0;lastFpsTime=0;fps=0;gameOver=!1;winner=null;roundNumber=1;killFeed=[];maxKillFeed=5;constructor(t,e=2){this.renderer=new Ot(t),this.input=new Dt,this.sharedWormhole=new nt,this.numBots=Math.min(Math.max(e,1),3),this.setupGrids(),this.setupInput()}setupGrids(){this.playerGrid=new rt({owner:"player",isPlayer:!0,shipColor:"#33ff33",shipStartX:n/2,shipStartY:a/2+200},this.sharedWormhole),this.setupGridCallbacks(this.playerGrid),this.grids.set("player",this.playerGrid);const t=["#33ccff","#ff33ff","#ffff33"],e=["bot-1","bot-2","bot-3"];for(let s=0;s<this.numBots;s++){const i=new rt({owner:e[s],isPlayer:!1,shipColor:t[s],shipStartX:n/2+(s===0?200:s===1?-200:0),shipStartY:a/2+(s===2?-200:0)},this.sharedWormhole);this.setupGridCallbacks(i),this.grids.set(e[s],i);const o={...Ht[s===0?"medium":s===1?"easy":"hard"],color:t[s]},h=new z(i,o);this.bots.set(e[s],h)}}setupGridCallbacks(t){t.onBankOrbs=(e,s)=>{this.handleBankOrbs(e,s)},t.onShipDestroyed=e=>{this.handleShipDestroyed(e)},t.onKillFeed=e=>{this.addKillFeed(e)}}setupInput(){this.input.onThrustStart=()=>{this.playerGrid.ship.thrusting=!0},this.input.onThrustEnd=()=>{this.playerGrid.ship.thrusting=!1},this.input.onRotateLeftStart=()=>{this.playerGrid.ship.rotatingLeft=!0},this.input.onRotateLeftEnd=()=>{this.playerGrid.ship.rotatingLeft=!1},this.input.onRotateRightStart=()=>{this.playerGrid.ship.rotatingRight=!0},this.input.onRotateRightEnd=()=>{this.playerGrid.ship.rotatingRight=!1},this.input.onShoot=()=>{this.handleShoot()},this.input.onBankSlot=t=>{this.handleBankSlot(t)}}handleShoot(){if(this.gameOver||this.playerGrid.ship.isDead)return;const t=performance.now();if(t-this.lastShotTime<this.SHOOT_COOLDOWN)return;this.lastShotTime=t;const e=this.playerGrid.ship,s=d.fromAngle(e.angle).mul(15),i=e.position.add(s);this.bullets.push(new tt(i,e.angle))}handleBankSlot(t){if(this.gameOver||this.playerGrid.ship.isDead)return;if(!this.playerGrid.wormhole.isInBankingZone(this.playerGrid.ship.position)){this.addKillFeed("[SYSTEM] Must be in upload zone!");return}const e=this.playerGrid.ship.getCargo();if(t>=e.length||!e[t]){this.addKillFeed(`[SYSTEM] Slot ${t+1} empty!`);return}const s=e[t];this.playerGrid.ship.removeCargoAt(t);const i=q([s],this.playerGrid.ship,this.playerGrid.wormhole.position);this.playerGrid.particles.createBankingBurst(this.playerGrid.wormhole.position,"#00ffff"),this.playerGrid.particles.createBurst(this.playerGrid.wormhole.position,this.getOrbColor(s),5,2,3,25),this.spawnAttackToRandomTarget("player",i),this.addKillFeed(`[UPLOAD] Slot ${t+1}: ${i.description}`)}handleBankOrbs(t,e){const s=this.grids.get(t);if(!s)return;const i=q(e,s.ship,s.wormhole.position);this.spawnAttackToRandomTarget(t,i);const r=t==="player"?"Player":t.toUpperCase().replace("-","-");this.addKillFeed(`${r} >> ${i.description}`)}spawnAttackToRandomTarget(t,e){const s=Array.from(this.grids.values()).filter(r=>r.owner!==t&&!r.ship.isDead);if(s.length===0)return;s[Math.floor(Math.random()*s.length)].spawnAttack(e,t)}handleShipDestroyed(t){const e=Array.from(this.grids.values()).filter(s=>!s.ship.isDead);if(e.length===1){this.winner=e[0].owner,this.gameOver=!0;const s=this.winner==="player"?"Player":this.winner.toUpperCase();this.addKillFeed(`${s} WINS THE ROUND!`)}}addKillFeed(t){this.killFeed.unshift(t),this.killFeed.length>this.maxKillFeed&&this.killFeed.pop()}start(){this.running=!0,this.lastTime=performance.now(),requestAnimationFrame(this.loop.bind(this))}stop(){this.running=!1}loop(t){if(this.running){try{const e=t-this.lastTime;for(this.lastTime=t,this.frameCount++,t-this.lastFpsTime>=1e3&&(this.fps=this.frameCount,this.frameCount=0,this.lastFpsTime=t),this.accumulator+=e;this.accumulator>=F;){this.sharedWormhole.update();for(const i of this.grids.values())i.update();for(const i of this.bots.values())i.update();this.updateBullets(),this.gameOver&&this.input.isActionPressed()&&this.restart(),this.accumulator-=F}const s=this.accumulator/F;this.render(s)}catch(e){console.error("GAME LOOP ERROR:",e),this.addKillFeed(`[ERROR] ${e instanceof Error?e.message:"Unknown error"}`)}requestAnimationFrame(this.loop.bind(this))}}updateBullets(){for(const s of this.bullets)s.update();const t=this.playerGrid.hazards,e=[];for(let s=this.bullets.length-1;s>=0;s--){const i=this.bullets[s];if(!i.active)continue;let r=!1;for(let o=t.length-1;o>=0;o--){const h=t[o];if(h.active&&i.collidesWith(h.position,h.radius)){r=!0,h.active=!1,e.push(h.id),this.playerGrid.particles.createBurst(h.position,"#ff6600",10,3,5,20),this.addKillFeed("[DEFENSE] Target destroyed!");break}}r&&(i.active=!1)}this.bullets=this.bullets.filter(s=>!s.isExpired()&&s.active),this.playerGrid.hazards=this.playerGrid.hazards.filter(s=>s.active)}render(t){const e=Array.from(this.grids.values());this.renderer.clear(),this.renderer.renderQuadrantView(e,this.playerGrid,this.bullets,t,this.fps,this.killFeed,this.gameOver,this.winner)}restart(){for(const t of this.grids.values())t.reset();this.bullets=[],this.gameOver=!1,this.winner=null,this.killFeed=[],this.roundNumber++}destroy(){this.stop(),this.input.destroy()}getOrbColor(t){switch(t){case l.RED:return"#ff4444";case l.BLUE:return"#4444ff";case l.GREEN:return"#44ff44";case l.GOLD:return"#ffcc00";default:return"#ffffff"}}}document.addEventListener("DOMContentLoaded",()=>{try{console.log("WORMHOLE: Initializing game...");const c=new zt("gameCanvas");console.log("WORMHOLE: Game created, starting..."),c.start(),console.log("WORMHOLE: Game started successfully!"),window.addEventListener("beforeunload",()=>{c.destroy()})}catch(c){console.error("WORMHOLE: Failed to initialize:",c);const t=document.getElementById("gameCanvas");if(t){const e=t.getContext("2d");e&&(e.fillStyle="#ff0000",e.font="20px monospace",e.fillText("Error: "+c.message,50,100))}}});
