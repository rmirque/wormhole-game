(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=e(s);fetch(s.href,r)}})();class c{x;y;constructor(t,e){this.x=t,this.y=e}static zero(){return new c(0,0)}static fromAngle(t){return new c(Math.cos(t),Math.sin(t))}add(t){return new c(this.x+t.x,this.y+t.y)}sub(t){return new c(this.x-t.x,this.y-t.y)}mul(t){return new c(this.x*t,this.y*t)}div(t){return new c(this.x/t,this.y/t)}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}normalize(){const t=this.length();return t===0?new c(0,0):this.div(t)}clamp(t){return this.length()>t?this.normalize().mul(t):new c(this.x,this.y)}lerp(t,e){return new c(this.x+(t.x-this.x)*e,this.y+(t.y-this.y)*e)}clone(){return new c(this.x,this.y)}dot(t){return this.x*t.x+this.y*t.y}}const B=1e3/60,it=.06,wt=.12,Et=.992,nt=5,b=12,H="#33ff33",n=1200,h=800,Tt="#001100",kt="#0a330a",st=50,vt=1.5,T=4,Y=3,Rt=180,rt=15,At="#33ff33";class Mt{position;velocity;angle;previousPosition;previousAngle;thrusting=!1;rotatingLeft=!1;rotatingRight=!1;cargo=new Array(T).fill(null);lives=Y;invulnerabilityTimer=0;isDead=!1;speedBoost=1;color;constructor(t,e,i=At){this.position=new c(t,e),this.velocity=c.zero(),this.angle=-Math.PI/2,this.color=i,this.previousPosition=this.position.clone(),this.previousAngle=this.angle}savePreviousState(){this.previousPosition=this.position.clone(),this.previousAngle=this.angle}update(){if(!this.isDead){if(this.rotatingLeft&&(this.angle-=it),this.rotatingRight&&(this.angle+=it),this.thrusting){const t=c.fromAngle(this.angle).mul(wt*this.speedBoost);this.velocity=this.velocity.add(t)}this.velocity=this.velocity.clamp(nt*this.speedBoost),this.velocity=this.velocity.mul(Et),this.position=this.position.add(this.velocity),this.wrapPosition(),this.invulnerabilityTimer>0&&this.invulnerabilityTimer--,this.speedBoost=1}}isInvulnerable(){return this.invulnerabilityTimer>0}isVisible(){return this.isInvulnerable()?Math.floor(Date.now()/100)%2===0:!0}takeDamage(){return this.isInvulnerable()||this.isDead?!1:(this.lives--,this.invulnerabilityTimer=Rt,this.clearCargo(),this.lives<=0?(this.isDead=!0,!0):!1)}applySpeedBoost(t){this.speedBoost=Math.max(this.speedBoost,t)}reset(t,e){this.position=new c(t,e),this.previousPosition=this.position.clone(),this.velocity=c.zero(),this.angle=-Math.PI/2,this.previousAngle=this.angle,this.lives=Y,this.invulnerabilityTimer=0,this.isDead=!1,this.cargo.fill(null),this.speedBoost=1}wrapPosition(){this.position.x<0?(this.position.x+=n,this.previousPosition.x+=n):this.position.x>n&&(this.position.x-=n,this.previousPosition.x-=n),this.position.y<0?(this.position.y+=h,this.previousPosition.y+=h):this.position.y>h&&(this.position.y-=h,this.previousPosition.y-=h)}getInterpolatedPosition(t){return this.previousPosition.lerp(this.position,t)}getInterpolatedAngle(t){return this.previousAngle+(this.angle-this.previousAngle)*t}getCargoCount(){return this.cargo.filter(t=>t!==null).length}isCargoFull(){return this.getCargoCount()>=T}isCargoEmpty(){return this.getCargoCount()===0}addCargo(t){const e=this.cargo.findIndex(i=>i===null);return e===-1?!1:(this.cargo[e]=t,!0)}clearCargo(){const t=this.cargo.filter(e=>e!==null);return this.cargo.fill(null),t}removeCargoAt(t){if(t<0||t>=T)return null;const e=this.cargo[t];return this.cargo[t]=null,e}getCargo(){return[...this.cargo]}}const Z=80,V=120,Pt=.018;class at{position;rotation=0;pulsePhase=0;pulseSpeed=.05;constructor(){this.position=new c(n/2,h/2)}update(){this.rotation+=Pt,this.pulsePhase+=this.pulseSpeed}getRotation(){return this.rotation}getTargetAngle(t=1,e=0){if(t<=0)return this.rotation;const i=Math.PI*2/t;return this.rotation+i*e}getPulseIntensity(){return(Math.sin(this.pulsePhase)+1)/2}isInBankingZone(t){return t.sub(this.position).length()<=V}isInWormhole(t){return t.sub(this.position).length()<=Z}}const q=12,Ot=.08,Ct=3;var l=(a=>(a.RED="red",a.BLUE="blue",a.GREEN="green",a.GOLD="gold",a))(l||{});const I={red:"#ff4444",blue:"#4444ff",green:"#44ff44",gold:"#ffcc00"},Dt={red:"rgba(255, 68, 68, 0.5)",blue:"rgba(68, 68, 255, 0.5)",green:"rgba(68, 255, 68, 0.5)",gold:"rgba(255, 204, 0, 0.6)"},It={red:.4,blue:.35,green:.2,gold:.05};class U{position;type;bobPhase;id;static nextId=0;constructor(t,e){this.id=U.nextId++,this.position=t,this.type=e,this.bobPhase=Math.random()*Math.PI*2}update(){this.bobPhase+=Ot}getVisualY(){return this.position.y+Math.sin(this.bobPhase)*Ct}getBobIntensity(){return(Math.sin(this.bobPhase)+1)/2}collidesWith(t,e){return this.position.sub(t).length()<=e+q}static getRandomType(){const t=Math.random();let e=0;for(const[i,s]of Object.entries(It))if(e+=s,t<=e)return i;return"red"}}var k=(a=>(a.ASTEROID="asteroid",a.SEEKER="seeker",a.MINE="mine",a.NUKE="nuke",a))(k||{});let N=0;class ht{id;type="asteroid";position;velocity;radius;lifetime;maxLifetime=900;active=!0;rotation=0;rotationSpeed;isLarge=!1;shapeOffsets=[];constructor(t,e,i=!1){this.id=N++,this.position=t,this.velocity=e,this.isLarge=i,this.radius=i?35:20,this.lifetime=this.maxLifetime,this.rotation=Math.random()*Math.PI*2,this.rotationSpeed=(Math.random()-.5)*.1;for(let s=0;s<8;s++)this.shapeOffsets.push(.8+Math.random()*.4)}update(){this.active&&(this.position=this.position.add(this.velocity),this.rotation+=this.rotationSpeed,this.position.x<this.radius?(this.position.x=this.radius,this.velocity.x=Math.abs(this.velocity.x)):this.position.x>n-this.radius&&(this.position.x=n-this.radius,this.velocity.x=-Math.abs(this.velocity.x)),this.position.y<this.radius?(this.position.y=this.radius,this.velocity.y=Math.abs(this.velocity.y)):this.position.y>h-this.radius&&(this.position.y=h-this.radius,this.velocity.y=-Math.abs(this.velocity.y)),this.lifetime--)}collidesWith(t,e){return this.active?this.position.sub(t).length()<=this.radius+e:!1}isExpired(){return this.lifetime<=0}}class Bt{id;type="seeker";position;velocity;radius=12;lifetime;maxLifetime=1200;active=!0;wobblePhase=0;maxSpeed;constructor(t){this.id=N++,this.position=t,this.maxSpeed=nt*.6,this.velocity=c.zero(),this.lifetime=this.maxLifetime,this.wobblePhase=Math.random()*Math.PI*2}targetShip=null;setTarget(t){this.targetShip=t}update(){if(!this.active)return;const t=this.targetShip;if(!t)return;this.wobblePhase+=.1;const e=t.position.sub(this.position);if(e.length()>0){let s=e.normalize();const r=.3,o=Math.cos(this.wobblePhase)*r,f=Math.sin(this.wobblePhase*1.3)*r;s=new c(s.x+o,s.y+f).normalize(),this.velocity=s.mul(this.maxSpeed)}this.position=this.position.add(this.velocity),this.position.x<0&&(this.position.x+=n),this.position.x>n&&(this.position.x-=n),this.position.y<0&&(this.position.y+=h),this.position.y>h&&(this.position.y-=h),this.lifetime--}collidesWith(t,e){return this.active?this.position.sub(t).length()<=this.radius+e:!1}isExpired(){return this.lifetime<=0}}class Nt{id;type="mine";position;velocity=c.zero();radius=10;armingRadius=60;lifetime;maxLifetime=1800;armingTime=120;active=!0;armed=!1;blinkPhase=0;constructor(t){this.id=N++,this.position=t,this.lifetime=this.maxLifetime}update(){this.active&&(this.armed?this.blinkPhase+=.2:(this.armingTime--,this.armingTime<=0&&(this.armed=!0)),this.lifetime--)}collidesWith(t,e){return this.active?this.armed?this.position.sub(t).length()<=this.armingRadius+e:this.position.sub(t).length()<=this.radius+e:!1}isExpired(){return this.lifetime<=0}getBlinkAlpha(){return this.armed?(Math.sin(this.blinkPhase)+1)/2*.8+.2:0}}class Lt{id;type="nuke";position;velocity=c.zero();radius=0;maxRadius=375;lifetime;maxLifetime;countdownTime=300;detonated=!1;explosionTime=0;maxExplosionTime=120;active=!0;safeZoneRadius=50;constructor(t){this.id=N++,this.position=t,this.maxLifetime=this.countdownTime+this.maxExplosionTime,this.lifetime=this.maxLifetime}update(){if(this.active){if(!this.detonated)this.countdownTime--,this.countdownTime<=0&&this.detonate();else{this.explosionTime++;const t=this.explosionTime/this.maxExplosionTime;this.radius=this.maxRadius*Math.min(t*1.5,1),this.explosionTime>=this.maxExplosionTime&&(this.active=!1)}this.lifetime--}}detonate(){this.detonated=!0,this.explosionTime=0}collidesWith(t,e){if(!this.active||!this.detonated||t.sub(this.position).length()<=this.safeZoneRadius)return!1;const s=[new c(0,0),new c(n,0),new c(0,h),new c(n,h)];for(const o of s)if(t.sub(o).length()<80)return!1;return this.position.sub(t).length()<=this.radius+e}isExpired(){return this.lifetime<=0}getCountdownSeconds(){return Math.ceil(this.countdownTime/60)}}class j{id;position;radius=100;lifetime=600;maxLifetime=600;active=!0;boostMultiplier=1.5;constructor(t,e=!1){this.id=N++,this.position=t,e&&(this.radius=150,this.boostMultiplier=2,this.lifetime=900,this.maxLifetime=900)}update(){this.lifetime--,this.lifetime<=0&&(this.active=!1)}contains(t){return this.active?this.position.sub(t).length()<=this.radius:!1}isExpired(){return this.lifetime<=0}getIntensity(){return this.lifetime/this.maxLifetime}}function Gt(a){return a.type===k.ASTEROID}function Wt(a){return a.type===k.SEEKER}function _t(a){return a.type===k.MINE}function $t(a){return a.type===k.NUKE}class Ut{canvas;ctx;offsetX=0;offsetY=0;constructor(t){const e=document.getElementById(t);if(!e)throw new Error(`Canvas element with id '${t}' not found`);this.canvas=e;const i=e.getContext("2d");if(!i)throw new Error("Could not get 2D rendering context");this.ctx=i,this.canvas.width=n,this.canvas.height=h,this.canvas.style.border="2px solid #1a1f3a",this.canvas.style.borderRadius="4px"}setOffset(t,e){this.offsetX=t,this.offsetY=e}clear(){this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.fillStyle=Tt,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore(),this.ctx.save(),this.ctx.translate(this.offsetX,this.offsetY)}renderGrid(){this.ctx.fillStyle=kt;for(let e=0;e<n;e+=st)for(let i=0;i<h;i+=st)this.ctx.beginPath(),this.ctx.arc(e,i,vt,0,Math.PI*2),this.ctx.fill();this.ctx.strokeStyle="#1a4a1a",this.ctx.lineWidth=2,this.ctx.strokeRect(0,0,n,h);const t=30;this.ctx.strokeStyle="#0d330d",this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.moveTo(0,t),this.ctx.lineTo(0,0),this.ctx.lineTo(t,0),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(n-t,0),this.ctx.lineTo(n,0),this.ctx.lineTo(n,t),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(0,h-t),this.ctx.lineTo(0,h),this.ctx.lineTo(t,h),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(n-t,h),this.ctx.lineTo(n,h),this.ctx.lineTo(n,h-t),this.ctx.stroke()}renderWormhole(t,e){const i=e?.3+t.getPulseIntensity()*.4:0;this.ctx.save(),this.ctx.translate(t.position.x,t.position.y),this.ctx.shadowBlur=20+i*20,this.ctx.shadowColor="#33ff33",this.ctx.strokeStyle=`rgba(51, 255, 51, ${.3+i*.4})`,this.ctx.lineWidth=2,this.ctx.setLineDash([10,5]),this.ctx.beginPath(),this.ctx.arc(0,0,V,0,Math.PI*2),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.shadowBlur=30,this.ctx.shadowColor="#00ff00",this.ctx.rotate(t.getRotation());for(let f=3;f>0;f--){const d=Z*(f/3),u=.2+i*.3;this.ctx.strokeStyle=`rgba(51, 255, 51, ${u})`,this.ctx.lineWidth=2,this.ctx.strokeRect(-d,-d,d*2,d*2),this.ctx.rotate(Math.PI/8)}this.ctx.fillStyle=`rgba(0, 255, 0, ${.6+i*.4})`,this.ctx.shadowBlur=40,this.ctx.fillRect(-15,-15,30,30),this.ctx.restore(),this.ctx.save(),this.ctx.translate(t.position.x,t.position.y);const s=t.getTargetAngle(1,0);this.ctx.rotate(s),this.ctx.strokeStyle="#ff3333",this.ctx.shadowBlur=10,this.ctx.shadowColor="#ff3333",this.ctx.lineWidth=2;const r=Z+25,o=15;this.ctx.beginPath(),this.ctx.moveTo(r-o,-o),this.ctx.lineTo(r,-o),this.ctx.lineTo(r,o),this.ctx.lineTo(r-o,o),this.ctx.stroke(),this.ctx.restore()}renderOrb(t){const e=t.getVisualY(),i=t.getBobIntensity();this.ctx.save(),this.ctx.translate(t.position.x,e),this.ctx.shadowBlur=8+i*6,this.ctx.shadowColor=I[t.type],this.ctx.fillStyle="#001100";const s=q*2;this.ctx.fillRect(-s/2,-s/2,s,s),this.ctx.strokeStyle=I[t.type],this.ctx.lineWidth=2,this.ctx.strokeRect(-s/2,-s/2,s,s),this.ctx.shadowBlur=4,this.renderOrbPixelIcon(t.type),this.ctx.restore()}renderOrbPixelIcon(t){this.ctx.fillStyle=I[t],this.ctx.shadowColor=I[t];const e=(i,s)=>{this.ctx.fillRect(i*3-6,s*3-6,3,3)};switch(t){case l.RED:e(1,0),e(2,0),e(0,1),e(3,1),e(1,2),e(2,2);break;case l.BLUE:e(1,0),e(0,1),e(2,1),e(1,1),e(1,2);break;case l.GREEN:e(1,0),e(1,1),e(1,2),e(1,3),e(0,1),e(2,1);break;case l.GOLD:e(1,0),e(0,1),e(1,2),e(2,1),e(1,1);break}}renderShip(t,e,i,s=!0,r=1){this.ctx.save(),this.ctx.translate(t.x,t.y),this.ctx.rotate(e),this.ctx.globalAlpha=s?r:.3,this.ctx.shadowBlur=15*r,this.ctx.shadowColor=H,this.ctx.fillStyle=H,this.ctx.strokeStyle=H,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(b,0),this.ctx.lineTo(-b*.7,b*.7),this.ctx.lineTo(-b*.4,0),this.ctx.lineTo(-b*.7,-b*.7),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),this.ctx.shadowBlur=0,i&&(this.ctx.shadowBlur=10*r,this.ctx.shadowColor="#ffaa00",this.ctx.fillStyle="#ffaa00",this.ctx.beginPath(),this.ctx.moveTo(-b*.4,0),this.ctx.lineTo(-b*1.2,b*.4),this.ctx.lineTo(-b*1.5,0),this.ctx.lineTo(-b*1.2,-b*.4),this.ctx.closePath(),this.ctx.fill(),this.ctx.shadowBlur=0),this.ctx.restore()}renderShipWithWrap(t,e,i,s=!0){this.renderShip(t,e,i,s,1);const r=b*1.5,o=d=>Math.min(1,d/r)*.4;if(t.x<r){const d=o(t.x);this.renderShip(new c(t.x+n,t.y),e,i,s,d)}if(t.x>n-r){const d=o(n-t.x);this.renderShip(new c(t.x-n,t.y),e,i,s,d)}if(t.y<r){const d=o(t.y);this.renderShip(new c(t.x,t.y+h),e,i,s,d)}if(t.y>h-r){const d=o(h-t.y);this.renderShip(new c(t.x,t.y-h),e,i,s,d)}const f=b;if(t.x<f&&t.y<f){const d=Math.min(o(t.x),o(t.y));this.renderShip(new c(t.x+n,t.y+h),e,i,s,d)}if(t.x>n-f&&t.y<f){const d=Math.min(o(n-t.x),o(t.y));this.renderShip(new c(t.x-n,t.y+h),e,i,s,d)}if(t.x<f&&t.y>h-f){const d=Math.min(o(t.x),o(h-t.y));this.renderShip(new c(t.x+n,t.y-h),e,i,s,d)}if(t.x>n-f&&t.y>h-f){const d=Math.min(o(n-t.x),o(h-t.y));this.renderShip(new c(t.x-n,t.y-h),e,i,s,d)}}renderParticles(t){for(const e of t.particles)this.ctx.save(),this.ctx.globalAlpha=e.alpha,this.ctx.fillStyle=e.color,this.ctx.beginPath(),this.ctx.arc(e.position.x,e.position.y,e.size,0,Math.PI*2),this.ctx.fill(),this.ctx.restore()}renderHUD(t,e,i,s){for(let y=0;y<Y;y++){const M=10+y*28;y<t.lives?(this.ctx.fillStyle="#ff4444",this.drawHeart(M+20/2,40+20/2,20/2)):(this.ctx.strokeStyle="#444444",this.ctx.lineWidth=2,this.drawHeartOutline(M+20/2,40+20/2,20/2))}const u=32,x=8,w=T*u+(T-1)*x,A=(n-w)/2,E=h-50,G=t.getCargo();for(let y=0;y<T;y++){const M=A+y*(u+x),P=G[y];if(this.ctx.strokeStyle="#4a4a6a",this.ctx.lineWidth=2,this.ctx.fillStyle="#1a1a2a",this.ctx.beginPath(),this.ctx.roundRect(M,E,u,u,4),this.ctx.fill(),this.ctx.stroke(),P){const O=M+u/2,C=E+u/2;this.ctx.fillStyle=Dt[P],this.ctx.beginPath(),this.ctx.arc(O,C,u/2+2,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle=I[P],this.ctx.beginPath(),this.ctx.arc(O,C,u/2-2,0,Math.PI*2),this.ctx.fill()}}if(this.ctx.fillStyle="#ffffff",this.ctx.font="14px monospace",this.ctx.textAlign="left",this.ctx.fillText(`FPS: ${e}`,10,20),this.ctx.fillStyle="#aaaaaa",this.ctx.font="12px monospace",this.ctx.textAlign="center",this.ctx.fillText(`CARGO (${t.getCargoCount()}/${T})`,n/2,E-10),i&&s&&s>0){const y=Math.min(s,1);this.ctx.save(),this.ctx.globalAlpha=y,this.ctx.fillStyle=i.tier>=3?"#ff8800":i.tier>=2?"#ff44ff":"#44ffff",this.ctx.font="bold 24px monospace",this.ctx.textAlign="center",this.ctx.fillText(i.description,n/2,100),this.ctx.restore()}!t.isCargoEmpty()&&!t.isDead&&(this.ctx.fillStyle="#00ffff",this.ctx.font="14px monospace",this.ctx.textAlign="center",this.ctx.fillText("Press SPACE to bank orbs!",n/2,h-80)),this.ctx.textAlign="left"}drawHeart(t,e,i){this.ctx.beginPath(),this.ctx.moveTo(t,e+i/4),this.ctx.quadraticCurveTo(t,e-i/2,t-i,e),this.ctx.quadraticCurveTo(t-i*1.5,e+i/2,t,e+i),this.ctx.quadraticCurveTo(t+i*1.5,e+i/2,t+i,e),this.ctx.quadraticCurveTo(t,e-i/2,t,e+i/4),this.ctx.fill()}drawHeartOutline(t,e,i){this.ctx.beginPath(),this.ctx.moveTo(t,e+i/4),this.ctx.quadraticCurveTo(t,e-i/2,t-i,e),this.ctx.quadraticCurveTo(t-i*1.5,e+i/2,t,e+i),this.ctx.quadraticCurveTo(t+i*1.5,e+i/2,t+i,e),this.ctx.quadraticCurveTo(t,e-i/2,t,e+i/4),this.ctx.stroke()}renderBankingIndicator(t,e,i){this.ctx.save(),this.ctx.translate(t.x,t.y);const s=e+Math.sin(Date.now()/200)*5;this.ctx.strokeStyle=`rgba(0, 255, 255, ${.3+i*.4})`,this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(0,0,s,0,Math.PI*2),this.ctx.stroke(),this.ctx.restore()}renderHazard(t){t.active&&(this.ctx.save(),this.ctx.translate(t.position.x,t.position.y),Gt(t)?this.renderAsteroid(t):Wt(t)?this.renderSeeker(t):_t(t)?this.renderMine(t):$t(t)&&this.renderNuke(t),this.ctx.restore())}renderAsteroid(t){this.ctx.save(),this.ctx.rotate(t.rotation),this.ctx.fillStyle="#8B7355",this.ctx.strokeStyle="#5C4033",this.ctx.lineWidth=2,this.ctx.beginPath();const e=t.radius;for(let i=0;i<8;i++){const s=i/8*Math.PI*2,r=e*t.shapeOffsets[i],o=Math.cos(s)*r,f=Math.sin(s)*r;i===0?this.ctx.moveTo(o,f):this.ctx.lineTo(o,f)}this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),this.ctx.restore()}renderSeeker(t){const e=this.ctx.createRadialGradient(0,0,5,0,0,25);e.addColorStop(0,"rgba(100, 150, 255, 0.8)"),e.addColorStop(1,"rgba(100, 150, 255, 0)"),this.ctx.fillStyle=e,this.ctx.beginPath(),this.ctx.arc(0,0,25,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#4488ff",this.ctx.beginPath(),this.ctx.arc(0,0,t.radius,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle=`rgba(100, 200, 255, ${.5+Math.sin(Date.now()/100)*.3})`,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(0,0,t.radius+5,0,Math.PI*2),this.ctx.stroke()}renderMine(t){if(!t.armed)return;const e=t.getBlinkAlpha(),i=this.ctx.createRadialGradient(0,0,0,0,0,t.armingRadius);i.addColorStop(0,`rgba(255, 100, 100, ${e*.3})`),i.addColorStop(1,"rgba(255, 100, 100, 0)"),this.ctx.fillStyle=i,this.ctx.beginPath(),this.ctx.arc(0,0,t.armingRadius,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle=`rgba(255, 0, 0, ${e})`,this.ctx.beginPath(),this.ctx.arc(0,0,4,0,Math.PI*2),this.ctx.fill()}renderNuke(t){if(t.detonated){const e=this.ctx.createRadialGradient(0,0,0,0,0,t.radius);e.addColorStop(0,"rgba(255, 255, 200, 0.9)"),e.addColorStop(.3,"rgba(255, 200, 100, 0.7)"),e.addColorStop(.7,"rgba(255, 100, 50, 0.4)"),e.addColorStop(1,"rgba(255, 50, 0, 0)"),this.ctx.fillStyle=e,this.ctx.beginPath(),this.ctx.arc(0,0,t.radius,0,Math.PI*2),this.ctx.fill()}else{const e=t.getCountdownSeconds();this.ctx.fillStyle="#ff0000",this.ctx.font="bold 30px monospace",this.ctx.textAlign="center",this.ctx.fillText(`NUKE IN ${e}`,0,-40);const i=(Math.sin(Date.now()/50)+1)/2;this.ctx.strokeStyle=`rgba(255, 0, 0, ${.5+i*.5})`,this.ctx.lineWidth=4,this.ctx.beginPath(),this.ctx.arc(0,0,30+i*20,0,Math.PI*2),this.ctx.stroke()}}renderBoostZone(t){if(!t.active)return;const e=t.getIntensity();this.ctx.save(),this.ctx.translate(t.position.x,t.position.y);const i=this.ctx.createRadialGradient(0,0,0,0,0,t.radius);i.addColorStop(0,`rgba(100, 255, 150, ${.1*e})`),i.addColorStop(.5,`rgba(100, 255, 150, ${.05*e})`),i.addColorStop(1,"rgba(100, 255, 150, 0)"),this.ctx.fillStyle=i,this.ctx.beginPath(),this.ctx.arc(0,0,t.radius,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle=`rgba(100, 255, 150, ${.3*e})`,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(0,0,t.radius,0,Math.PI*2),this.ctx.stroke(),this.ctx.restore()}renderGameOver(t){this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(0,0,n,h),this.ctx.fillStyle="#ff4444",this.ctx.font="bold 60px monospace",this.ctx.textAlign="center",this.ctx.fillText("GAME OVER",n/2,h/2-50),this.ctx.fillStyle="#ffffff",this.ctx.font="24px monospace",this.ctx.fillText("You ran out of lives!",n/2,h/2+10),t&&(this.ctx.fillStyle="#00ff88",this.ctx.font="20px monospace",this.ctx.fillText("Press SPACE to restart",n/2,h/2+60))}renderQuadrantView(t,e,i,s,r,o,f,d){const u=this.canvas.width,x=this.canvas.height,w=8,A=10,E=28,G=55,y=E+w,P=x-G-w-y,O=Math.floor((u-w*2-A)*.7),C=w+O+A,lt=u-C-w;this.ctx.fillStyle="#000800",this.ctx.fillRect(0,0,u,x),this.ctx.fillStyle="rgba(0, 40, 0, 0.8)",this.ctx.fillRect(0,0,u,E),this.ctx.strokeStyle="#1a5a1a",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(0,E),this.ctx.lineTo(u,E),this.ctx.stroke(),this.ctx.shadowBlur=0,this.ctx.font="14px VT323, monospace",this.ctx.fillStyle="#33ff33",this.ctx.textAlign="left",this.ctx.fillText(`SYS:ONLINE FPS:${r}`,w+5,E-8);const ft="♥".repeat(e.ship.lives)+"♡".repeat(3-e.ship.lives);this.ctx.fillStyle="#ff3333",this.ctx.textAlign="right",this.ctx.fillText(`LIVES:${ft}`,u-w-5,E-8);const S={x:w,y,w:O,h:P};this.ctx.strokeStyle="#33ff33",this.ctx.lineWidth=2,this.ctx.strokeRect(S.x,S.y,S.w,S.h),this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(S.x+2,S.y+2,S.w-4,S.h-4),this.ctx.clip();const dt=(S.w-4)/n,ut=(S.h-4)/h,W=Math.min(dt,ut),pt=(S.w-4-n*W)/2,xt=(S.h-4-h*W)/2;this.ctx.translate(S.x+2+pt,S.y+2+xt),this.ctx.scale(W,W),this.renderGridState(e,i,s,!0),this.ctx.restore();const _=t.filter(g=>!g.isPlayer),J=(P-(_.length-1)*A)/_.length;let tt=y;for(let g=0;g<_.length;g++){const m=_[g],p={x:C,y:tt,w:lt,h:J};this.ctx.strokeStyle=m.ship.color,this.ctx.lineWidth=1,this.ctx.strokeRect(p.x,p.y,p.w,p.h),this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(p.x+1,p.y+1,p.w-2,p.h-2),this.ctx.clip();const mt=(p.w-2)/n,yt=(p.h-2)/h,$=Math.min(mt,yt),St=(p.w-2-n*$)/2,bt=(p.h-2-h*$)/2;this.ctx.translate(p.x+1+St,p.y+1+bt),this.ctx.scale($,$),this.renderGridState(m,[],s,!1),this.ctx.restore(),this.ctx.fillStyle=m.ship.color,this.ctx.font="10px VT323, monospace",this.ctx.textAlign="left",this.ctx.shadowBlur=0,this.ctx.fillText(`${m.owner.toUpperCase().replace("-","")} ♥${m.ship.lives} [${m.ship.getCargoCount()}/4]`,p.x+4,p.y+p.h-4),tt+=J+A}const D=x-G+5,v=22,gt=4,et=e.ship.getCargo();this.ctx.fillStyle="#1a991a",this.ctx.font="12px VT323, monospace",this.ctx.textAlign="left",this.ctx.fillText("BUFFER:",w+5,D+15);for(let g=0;g<4;g++){const m=w+50+g*(v+gt),p=D+2;this.ctx.strokeStyle=et[g]?"#33ff33":"#0a330a",this.ctx.lineWidth=1,this.ctx.strokeRect(m,p,v,v),et[g]&&(this.ctx.fillStyle="#33ff33",this.ctx.fillRect(m+2,p+2,v-4,v-4)),this.ctx.fillStyle="#1a5a1a",this.ctx.font="8px VT323, monospace",this.ctx.textAlign="center",this.ctx.fillText(String(g+1),m+v/2,p+v+10)}if(this.ctx.fillStyle="#448844",this.ctx.font="11px VT323, monospace",this.ctx.textAlign="center",this.ctx.fillText("[SPACE] FIRE",u/2,D+12),this.ctx.fillText("[1][2][3][4] UPLOAD",u/2,D+26),o.length>0){this.ctx.textAlign="right";let g=D+12;for(let m=0;m<Math.min(3,o.length);m++){const p=o[m];this.ctx.fillStyle=p.includes("WINS")?"#ccaa00":p.includes("destroyed")?"#ff4444":"#888888",this.ctx.font="10px VT323, monospace",this.ctx.fillText(p,u-w-5,g),g+=12}}if(f){this.ctx.fillStyle="rgba(0, 0, 0, 0.85)",this.ctx.fillRect(0,0,u,x);const g=d==="player";this.ctx.fillStyle=g?"#33ff33":"#ff3333",this.ctx.font="bold 48px VT323, monospace",this.ctx.textAlign="center",this.ctx.fillText(g?"VICTORY":"DEFEAT",u/2,x/2-20),this.ctx.fillStyle="#ffffff",this.ctx.font="20px VT323, monospace";const m=d==="player"?"PLAYER":d?.toUpperCase()||"UNKNOWN";this.ctx.fillText(`${m} WINS`,u/2,x/2+15),this.ctx.fillStyle="#00ffff",this.ctx.font="14px VT323, monospace",this.ctx.fillText("[SPACE] RESTART",u/2,x/2+45)}}renderGridState(t,e,i,s){if(t.screenShake>0){const r=(Math.random()-.5)*t.screenShake,o=(Math.random()-.5)*t.screenShake;this.ctx.translate(r,o)}this.ctx.fillStyle="#001100",this.ctx.fillRect(0,0,n,h),s&&this.renderGrid();for(const r of t.boostZones)this.renderBoostZone(r);for(const r of t.orbs.values())this.renderOrb(r);this.renderWormhole(t.wormhole,t.bankingPulse>.5);for(const r of t.hazards)this.renderHazard(r);if(!t.ship.isDead){const r=t.ship.getInterpolatedPosition(i),o=t.ship.getInterpolatedAngle(i);this.renderShipWithWrap(r,o,t.ship.thrusting,t.ship.isVisible())}if(s)for(const r of e)r.active&&this.renderBullet(r);s&&this.renderParticles(t.particles)}renderBullet(t){this.ctx.save(),this.ctx.translate(t.position.x,t.position.y),this.ctx.rotate(t.angle),this.ctx.shadowBlur=8,this.ctx.shadowColor="#ffff00",this.ctx.fillStyle="#ffff00",this.ctx.fillRect(-4,-2,8,4),this.ctx.fillStyle="#ffaa00",this.ctx.fillRect(-8,-1,4,2),this.ctx.restore()}renderOrbIcon(t,e,i,s){const r=t+i/2,o=e+i/2,f=3;switch(this.ctx.save(),s){case l.RED:this.ctx.shadowBlur=8,this.ctx.shadowColor="#ff4444",this.ctx.fillStyle="#ff4444";const d=[[0,1,0],[1,1,1],[1,0,1]];this.drawPixelPattern(r,o,f,d);break;case l.BLUE:this.ctx.shadowBlur=8,this.ctx.shadowColor="#4444ff",this.ctx.fillStyle="#4444ff";const u=[[0,1,0],[1,0,1],[0,1,0]];this.drawPixelPattern(r,o,f,u);break;case l.GREEN:this.ctx.shadowBlur=8,this.ctx.shadowColor="#44ff44",this.ctx.fillStyle="#44ff44";const x=[[0,1,0],[1,1,1],[0,1,0]];this.drawPixelPattern(r,o,f,x),this.ctx.fillRect(r-6,o-6,2,2),this.ctx.fillRect(r+4,o-6,2,2),this.ctx.fillRect(r-6,o+4,2,2),this.ctx.fillRect(r+4,o+4,2,2);break;case l.GOLD:this.ctx.shadowBlur=10,this.ctx.shadowColor="#ffcc00",this.ctx.fillStyle="#ffcc00",this.ctx.fillRect(r-2,o-2,4,4),this.ctx.fillRect(r-2,o-6,4,3),this.ctx.fillRect(r+3,o+2,3,4),this.ctx.fillRect(r-6,o+2,3,4);break}this.ctx.restore()}drawPixelPattern(t,e,i,s){const r=s.length,o=s[0].length,f=t-o*i/2,d=e-r*i/2;for(let u=0;u<r;u++)for(let x=0;x<o;x++)s[u][x]&&this.ctx.fillRect(f+x*i,d+u*i,i,i)}getCanvas(){return this.canvas}}class Kt{keys=new Set;actionPressed=!1;onThrustStart;onThrustEnd;onRotateLeftStart;onRotateLeftEnd;onRotateRightStart;onRotateRightEnd;onShoot;onBankSlot;constructor(){this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this),window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp)}destroy(){window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp)}handleKeyDown(t){const e=t.key.toLowerCase();if(["w","a","s","d"," ","1","2","3","4","arrowup","arrowleft","arrowright","arrowdown"].includes(e)&&t.preventDefault(),!this.keys.has(e))switch(this.keys.add(e),e){case"w":case"arrowup":this.onThrustStart?.();break;case"a":case"arrowleft":this.onRotateLeftStart?.();break;case"d":case"arrowright":this.onRotateRightStart?.();break;case"s":case"arrowdown":break;case" ":this.actionPressed=!0,this.onShoot?.();break;case"1":this.onBankSlot?.(0);break;case"2":this.onBankSlot?.(1);break;case"3":this.onBankSlot?.(2);break;case"4":this.onBankSlot?.(3);break}}handleKeyUp(t){const e=t.key.toLowerCase();switch(this.keys.delete(e),e){case"w":case"arrowup":this.onThrustEnd?.();break;case"a":case"arrowleft":this.onRotateLeftEnd?.();break;case"d":case"arrowright":this.onRotateRightEnd?.();break}}isPressed(t){return this.keys.has(t.toLowerCase())}isActionPressed(){const t=this.actionPressed;return this.actionPressed=!1,t}}class Ft{particles=[];createBurst(t,e,i=10,s=3,r=4,o=30){for(let f=0;f<i;f++){const d=Math.PI*2*f/i+Math.random()*.5,u=Math.random()*s+1,x=c.fromAngle(d).mul(u);this.particles.push({position:t.clone(),velocity:x,life:o,maxLife:o,size:r*(.5+Math.random()*.5),color:e,alpha:1})}}createCollectionBurst(t,e){this.createBurst(t,e,12,4,5,40)}createBankingBurst(t,e){this.createBurst(t,e,20,6,6,50)}update(){for(let t=this.particles.length-1;t>=0;t--){const e=this.particles[t];e.position=e.position.add(e.velocity),e.velocity=e.velocity.mul(.95),e.life--,e.alpha=e.life/e.maxLife,e.life<=0&&this.particles.splice(t,1)}}clear(){this.particles=[]}getCount(){return this.particles.length}}function X(a,t,e){const i={[l.RED]:0,[l.BLUE]:0,[l.GREEN]:0,[l.GOLD]:0};for(const s of a)i[s]++;if(i[l.GOLD]>=8)return{hazards:[Vt(e)],boostZones:[],tier:4,description:"NUKE DETONATED!"};for(const s of[l.RED,l.BLUE,l.GREEN])if(i[s]>=4)return Zt(s,t,e);if(i[l.RED]>=1&&i[l.BLUE]>=1&&i[l.GREEN]>=1)return Yt(t,e);for(const s of[l.RED,l.BLUE,l.GREEN])if(i[s]>=3)return zt(s,t,e);for(const s of[l.RED,l.BLUE,l.GREEN])if(i[s]>=2)return Ht(s,t,e);return i[l.RED]>=1?z(l.RED,t,e):i[l.BLUE]>=1?z(l.BLUE,t,e):i[l.GREEN]>=1?z(l.GREEN,t,e):{hazards:[],boostZones:[],tier:1,description:"Nothing happened..."}}function z(a,t,e){const i=[],s=[];let r="";switch(a){case l.RED:for(let o=0;o<3;o++)i.push(R(e,!1));r="3 Asteroids spawned!";break;case l.BLUE:i.push(L(t,e)),r="Seeker Drone launched!";break;case l.GREEN:s.push(new j(e,!1)),r="Speed Boost Zone created!";break}return{hazards:i,boostZones:s,tier:1,description:r}}function Ht(a,t,e){const i=[],s=[];let r="";switch(a){case l.RED:for(let o=0;o<3;o++)i.push(R(e,!1));for(let o=0;o<2;o++)i.push(R(e,!0));r="Enhanced Asteroid Swarm!";break;case l.BLUE:for(let o=0;o<2;o++)i.push(L(t,e));r="Twin Seekers launched!";break;case l.GREEN:s.push(new j(e,!0)),r="Enhanced Speed Zone!";break}return{hazards:i,boostZones:s,tier:1.5,description:r}}function zt(a,t,e){const i=[],s=[];let r="";switch(a){case l.RED:i.push(...Xt()),r="ASTEROID WALL!";break;case l.BLUE:for(let o=0;o<3;o++)i.push(L(t,e));r="Seeker Swarm!";break;case l.GREEN:for(let o=0;o<8;o++)i.push(K(e));r="MINE FIELD deployed!";break}return{hazards:i,boostZones:s,tier:2,description:r}}function Yt(a,t){const e=[];return e.push(R(t,!1)),e.push(R(t,!0)),e.push(L(a,t)),e.push(K(t)),e.push(K(t)),{hazards:e,boostZones:[],tier:2,description:"CHAOS STORM!"}}function Zt(a,t,e){const i=[],s=[];let r="";switch(a){case l.RED:for(let o=0;o<8;o++)i.push(R(e,!1));for(let o=0;o<4;o++)i.push(R(e,!0));r="MEGA ASTEROID BARRAGE!";break;case l.BLUE:for(let o=0;o<5;o++)i.push(L(t,e));r="MEGA SEEKER SWARM!";break;case l.GREEN:for(let o=0;o<12;o++)i.push(K(e));s.push(new j(e,!0)),r="MEGA DEFENSE GRID!";break}return{hazards:i,boostZones:s,tier:3,description:r}}function R(a,t){const e=qt(),i=Math.random()*Math.PI*2,s=1+Math.random()*2,r=c.fromAngle(i).mul(s);return new ht(e,r,t)}function Xt(a){const t=[],e=Math.floor(Math.random()*4),i=8;let s=0,r=0,o=c.zero();switch(e){case 0:s=n/2-200,r=50,o=new c(0,2+Math.random());break;case 1:s=n-50,r=h/2-200,o=new c(-(2+Math.random()),0);break;case 2:s=n/2-200,r=h-50,o=new c(0,-(2+Math.random()));break;case 3:s=50,r=h/2-200,o=new c(2+Math.random(),0);break}const f=(e%2===0,60);for(let d=0;d<i;d++){const u=e%2===0?s+d*f:s,x=e%2===1?r+d*f:r;t.push(new ht(new c(u,x),o.clone(),d%3===0))}return t}function L(a,t){const e=ct(t,150),i=new Bt(e);return i.setTarget(a),i}function K(a){const t=ct(a,250);return new Nt(t)}function Vt(a){return new Lt(a)}function qt(a,t){const e=Math.floor(Math.random()*4);let i=0,s=0;switch(e){case 0:i=Math.random()*n,s=30;break;case 1:i=n-30,s=Math.random()*h;break;case 2:i=Math.random()*n,s=h-30;break;case 3:i=30,s=Math.random()*h;break}return new c(i,s)}function ct(a,t){const e=Math.random()*Math.PI*2,i=t+Math.random()*200;return new c(a.x+Math.cos(e)*i,a.y+Math.sin(e)*i)}class ot{owner;isPlayer;ship;wormhole;orbs=new Map;hazards=[];boostZones=[];particles;orbSpawnTimer=0;nextOrbSpawnTime=3e3;MAX_ORBS=12;MIN_SPAWN_DISTANCE=150;MIN_EDGE_DISTANCE=50;SPAWN_INTERVAL_MIN=2e3;SPAWN_INTERVAL_MAX=4e3;bankingPulse=0;lastAttackResult=null;attackMessageTimer=0;ATTACK_MESSAGE_DURATION=180;screenShake=0;SCREEN_SHAKE_DECAY=.9;gameOver=!1;gameOverTimer=0;winner=null;onBankOrbs;onShipDestroyed;onKillFeed;constructor(t,e){this.owner=t.owner,this.isPlayer=t.isPlayer,this.ship=new Mt(t.shipStartX,t.shipStartY,t.shipColor),this.wormhole=e||new at,this.particles=new Ft}update(){if(this.gameOver){this.gameOverTimer++,this.particles.update();return}this.ship.savePreviousState(),this.ship.update(),this.wormhole&&this.wormhole.update();for(const t of this.orbs.values())t.update();for(const t of this.hazards)t.update();for(const t of this.boostZones)t.update();this.particles.update(),this.updateOrbSpawning(),this.checkCollisions(),this.checkBoostZones(),this.attackMessageTimer>0&&this.attackMessageTimer--,!this.ship.isDead&&this.wormhole.isInBankingZone(this.ship.position)?this.bankingPulse=Math.min(this.bankingPulse+.05,1):this.bankingPulse=Math.max(this.bankingPulse-.05,0),this.screenShake*=this.SCREEN_SHAKE_DECAY,this.screenShake<.5&&(this.screenShake=0),this.hazards=this.hazards.filter(t=>!t.isExpired()&&t.active),this.boostZones=this.boostZones.filter(t=>!t.isExpired()&&t.active),this.ship.isDead&&!this.gameOver&&this.handleGameOver()}bankOrbs(){if(console.log(`[GRIDSTATE BANK] ${this.owner} bankOrbs called, inZone=${this.wormhole.isInBankingZone(this.ship.position)}, empty=${this.ship.isCargoEmpty()}`),this.wormhole.isInBankingZone(this.ship.position)&&!this.ship.isCargoEmpty()){const t=this.ship.clearCargo();console.log(`[GRIDSTATE BANK] ${this.owner} banking ${t.length} orbs: ${t.join(",")}`),this.particles.createBankingBurst(this.wormhole.position,"#00ffff");for(const i of t){const s=this.getOrbColor(i);this.particles.createBurst(this.wormhole.position,s,5,2,3,25)}console.log(`[GRIDSTATE BANK] ${this.owner} calling onBankOrbs callback, exists=${!!this.onBankOrbs}`),this.onBankOrbs?.(this.owner,t);const e=X(t,this.ship,this.wormhole.position);this.lastAttackResult=e,this.attackMessageTimer=this.ATTACK_MESSAGE_DURATION,e.tier>=3?this.screenShake=20:e.tier>=2?this.screenShake=10:this.screenShake=5}}spawnAttack(t,e){console.log(`[GRIDSTATE SPAWN] ${this.owner} spawnAttack called from ${e}, hazards=${t.hazards.length}, boostZones=${t.boostZones.length}`);for(const s of t.hazards)s.type===k.SEEKER&&s.setTarget(this.ship);this.hazards.push(...t.hazards),this.boostZones.push(...t.boostZones),console.log(`[GRIDSTATE SPAWN] ${this.owner} now has ${this.hazards.length} total hazards`);const i=e==="player"?"Player":e.toUpperCase();this.lastAttackResult={...t,description:`${i}: ${t.description}`},this.attackMessageTimer=this.ATTACK_MESSAGE_DURATION,t.tier>=3?this.screenShake=20:t.tier>=2?this.screenShake=10:this.screenShake=5}updateOrbSpawning(){this.orbs.size>=this.MAX_ORBS||(this.orbSpawnTimer+=B,this.orbSpawnTimer>=this.nextOrbSpawnTime&&(this.spawnOrb(),this.orbSpawnTimer=0,this.nextOrbSpawnTime=this.SPAWN_INTERVAL_MIN+Math.random()*(this.SPAWN_INTERVAL_MAX-this.SPAWN_INTERVAL_MIN)))}spawnOrb(){let t=0;const e=50;for(;t<e;){const i=this.MIN_EDGE_DISTANCE+Math.random()*(n-this.MIN_EDGE_DISTANCE*2),s=this.MIN_EDGE_DISTANCE+Math.random()*(h-this.MIN_EDGE_DISTANCE*2),r=new c(i,s),o=new c(n/2,h/2);if(r.sub(o).length()>=this.MIN_SPAWN_DISTANCE){let f=!1;for(const d of this.orbs.values())if(r.sub(d.position).length()<q*3){f=!0;break}if(!f){const d=U.getRandomType(),u=new U(r,d);this.orbs.set(u.id,u);return}}t++}}checkCollisions(){for(const[t,e]of this.orbs.entries())if(e.collidesWith(this.ship.position,rt)&&this.ship.addCargo(e.type)){const i=this.getOrbColor(e.type);this.particles.createCollectionBurst(e.position,i),this.orbs.delete(t)}if(!this.ship.isInvulnerable()){for(const t of this.hazards)if(t.collidesWith(this.ship.position,rt)){this.handleShipHit(t);break}}}checkBoostZones(){for(const t of this.boostZones)t.contains(this.ship.position)&&this.ship.applySpeedBoost(t.boostMultiplier)}handleShipHit(t){if(this.particles.createBurst(this.ship.position,"#ff4400",20,5,8,40),this.screenShake=15,this.ship.takeDamage()){this.particles.createBurst(this.ship.position,"#ff0000",50,8,12,80);const i=t.type==="seeker"?"Seeker Drone":t.type==="asteroid"?"Asteroid":t.type==="mine"?"Mine":t.type==="nuke"?"NUKE":"Unknown";this.onKillFeed?.(`${this.getDisplayName()} was destroyed by ${i}`),this.onShipDestroyed?.(this.owner)}}handleGameOver(){this.gameOver=!0}markWinner(){this.winner=this.owner,this.gameOver=!0}reset(){this.ship.reset(n/2,h/2+200),this.hazards=[],this.boostZones=[],this.orbs.clear(),this.particles.clear(),this.gameOver=!1,this.gameOverTimer=0,this.screenShake=0,this.lastAttackResult=null,this.attackMessageTimer=0,this.winner=null,this.orbSpawnTimer=0}getDisplayName(){return this.isPlayer?"Player":this.owner.toUpperCase().replace("-","-")}getOrbColor(t){switch(t){case l.RED:return"#ff4444";case l.BLUE:return"#4444ff";case l.GREEN:return"#44ff44";case l.GOLD:return"#ffcc00";default:return"#ffffff"}}}const jt={easy:{difficulty:"easy",reactionDelay:250,steeringAccuracy:.7,bankThreshold:.8,evadeDistance:100},medium:{difficulty:"medium",reactionDelay:133,steeringAccuracy:.85,bankThreshold:.6,evadeDistance:150},hard:{difficulty:"hard",reactionDelay:33,steeringAccuracy:.97,bankThreshold:.4,evadeDistance:200}};class F{grid;config;currentState="collect";stateTimer=0;lastDecisionTime=0;pendingAction=null;targetOrb=null;targetPosition=null;static CORNERS=[new c(50,50),new c(n-50,50),new c(50,h-50),new c(n-50,h-50)];constructor(t,e){this.grid=t,this.config=e,this.lastDecisionTime=performance.now()}update(){if(this.grid.ship.isDead||this.grid.gameOver){this.stopShip();return}const t=performance.now();this.checkStateTransitions(),t-this.lastDecisionTime>=this.config.reactionDelay&&(this.executeStateBehavior(),this.lastDecisionTime=t),this.applyMovement()}checkStateTransitions(){const t=this.grid.ship,e=this.grid.hazards,i=t.getCargoCount()/T;if(e.find(o=>o.type!==k.NUKE?!1:!o.detonated)){this.currentState!=="flee_nuke"&&(this.currentState="flee_nuke",this.targetPosition=this.findNearestCorner());return}const r=this.findNearestHazard();if(r&&r.distance<this.config.evadeDistance){this.currentState!=="evade"&&(this.currentState="evade",this.targetPosition=this.calculateEscapeVector(r.hazard));return}if(i>=this.config.bankThreshold){this.currentState!=="bank"&&(this.currentState="bank",this.targetPosition=this.grid.wormhole.position);return}this.currentState!=="collect"&&(this.currentState="collect",this.targetOrb=null)}executeStateBehavior(){switch(this.currentState){case"collect":this.executeCollect();break;case"bank":this.executeBank();break;case"evade":this.executeEvade();break;case"flee_nuke":this.executeFleeNuke();break}}executeCollect(){const t=this.grid.ship;let e=null,i=1/0;for(const s of this.grid.orbs.values()){const r=s.position.sub(t.position).length();r<i&&(i=r,e=s)}if(e)this.targetOrb=e,this.steerToward(e.position);else{const s=Date.now()/2e3,r=new c(n/2+Math.cos(s)*300,h/2+Math.sin(s)*300);this.steerToward(r)}}executeBank(){const t=this.grid.ship,e=this.grid.wormhole;t.position.sub(e.position).length()<V?(console.log(`[BOT BANK] ${this.grid.owner} is banking ${t.getCargoCount()} orbs`),this.grid.bankOrbs(),this.currentState="collect"):this.steerToward(e.position)}executeEvade(){const t=this.findNearestHazard();if(!t||t.distance>this.config.evadeDistance*1.5){this.currentState="collect";return}const e=this.calculateEscapeVector(t.hazard);this.steerToward(e)}executeFleeNuke(){if(!this.grid.hazards.find(e=>e.type!==k.NUKE?!1:!e.detonated)){this.currentState="collect";return}this.targetPosition=this.findNearestCorner(),this.targetPosition&&(this.grid.ship.position.sub(this.targetPosition).length()<30?this.stopShip():this.steerToward(this.targetPosition))}steerToward(t){const e=this.grid.ship,i=t.sub(e.position);let r=Math.atan2(i.y,i.x)-e.angle;for(;r>Math.PI;)r-=Math.PI*2;for(;r<-Math.PI;)r+=Math.PI*2;const o=this.config.steeringAccuracy,f=r*o+(Math.random()-.5)*.1*(1-o);Math.abs(f)>.1?(e.rotatingLeft=f<0,e.rotatingRight=f>0):(e.rotatingLeft=!1,e.rotatingRight=!1);const d=i.length(),u=Math.abs(r);e.thrusting=u<Math.PI/3||d>400}applyMovement(){}stopShip(){this.grid.ship.thrusting=!1,this.grid.ship.rotatingLeft=!1,this.grid.ship.rotatingRight=!1}findNearestHazard(){let t=null,e=1/0;for(const i of this.grid.hazards){if(!i.active)continue;const s=i.position.sub(this.grid.ship.position).length();s<e&&(e=s,t=i)}return t?{hazard:t,distance:e}:null}calculateEscapeVector(t){const e=this.grid.ship;let i=e.position.sub(t.position);return i.length()<10&&(i=c.fromAngle(Math.random()*Math.PI*2)),i=i.normalize(),e.position.add(i.mul(200))}findNearestCorner(){let t=F.CORNERS[0],e=1/0;for(const i of F.CORNERS){const s=i.sub(this.grid.ship.position).length();s<e&&(e=s,t=i)}return t}getStateName(){return this.currentState}reset(){this.currentState="collect",this.stateTimer=0,this.lastDecisionTime=performance.now(),this.pendingAction=null,this.targetOrb=null,this.targetPosition=null,this.stopShip()}}const Qt=12,Jt=40,te=3;class Q{position;velocity;angle;lifetime=Jt;active=!0;id;static nextId=0;constructor(t,e){this.id=Q.nextId++,this.position=t.clone(),this.angle=e,this.velocity=c.fromAngle(e).mul(Qt)}update(){this.active&&(this.position=this.position.add(this.velocity),this.lifetime--,this.position.x<0&&(this.position.x+=n),this.position.x>n&&(this.position.x-=n),this.position.y<0&&(this.position.y+=h),this.position.y>h&&(this.position.y-=h),this.lifetime<=0&&(this.active=!1))}collidesWith(t,e){return this.active?this.position.sub(t).length()<=te+e:!1}isExpired(){return this.lifetime<=0||!this.active}}class ee{renderer;input;sharedWormhole;grids=new Map;playerGrid;bots=new Map;numBots=2;bullets=[];lastShotTime=0;SHOOT_COOLDOWN=150;lastTime=0;accumulator=0;running=!1;frameCount=0;lastFpsTime=0;fps=0;gameOver=!1;winner=null;roundNumber=1;killFeed=[];maxKillFeed=5;constructor(t,e=2){this.renderer=new Ut(t),this.input=new Kt,this.sharedWormhole=new at,this.numBots=Math.min(Math.max(e,1),3),this.setupGrids(),this.setupInput()}setupGrids(){this.playerGrid=new ot({owner:"player",isPlayer:!0,shipColor:"#33ff33",shipStartX:n/2,shipStartY:h/2+200},this.sharedWormhole),this.setupGridCallbacks(this.playerGrid),this.grids.set("player",this.playerGrid);const t=["#33ccff","#ff33ff","#ffff33"],e=["bot-1","bot-2","bot-3"];for(let i=0;i<this.numBots;i++){const s=new ot({owner:e[i],isPlayer:!1,shipColor:t[i],shipStartX:n/2+(i===0?200:i===1?-200:0),shipStartY:h/2+(i===2?-200:0)},this.sharedWormhole);this.setupGridCallbacks(s),this.grids.set(e[i],s);const o={...jt[i===0?"medium":i===1?"easy":"hard"],color:t[i]},f=new F(s,o);this.bots.set(e[i],f)}}setupGridCallbacks(t){t.onBankOrbs=(e,i)=>{this.handleBankOrbs(e,i)},t.onShipDestroyed=e=>{this.handleShipDestroyed(e)},t.onKillFeed=e=>{this.addKillFeed(e)}}setupInput(){this.input.onThrustStart=()=>{this.playerGrid.ship.thrusting=!0},this.input.onThrustEnd=()=>{this.playerGrid.ship.thrusting=!1},this.input.onRotateLeftStart=()=>{this.playerGrid.ship.rotatingLeft=!0},this.input.onRotateLeftEnd=()=>{this.playerGrid.ship.rotatingLeft=!1},this.input.onRotateRightStart=()=>{this.playerGrid.ship.rotatingRight=!0},this.input.onRotateRightEnd=()=>{this.playerGrid.ship.rotatingRight=!1},this.input.onShoot=()=>{this.handleShoot()},this.input.onBankSlot=t=>{this.handleBankSlot(t)}}handleShoot(){if(this.gameOver||this.playerGrid.ship.isDead)return;const t=performance.now();if(t-this.lastShotTime<this.SHOOT_COOLDOWN)return;this.lastShotTime=t;const e=this.playerGrid.ship,i=c.fromAngle(e.angle).mul(15),s=e.position.add(i);this.bullets.push(new Q(s,e.angle))}handleBankSlot(t){if(this.gameOver||this.playerGrid.ship.isDead)return;if(!this.playerGrid.wormhole.isInBankingZone(this.playerGrid.ship.position)){this.addKillFeed("[SYSTEM] Must be in upload zone!");return}const e=this.playerGrid.ship.getCargo();if(t>=e.length||!e[t]){this.addKillFeed(`[SYSTEM] Slot ${t+1} empty!`);return}const i=e[t];this.playerGrid.ship.removeCargoAt(t);const s=X([i],this.playerGrid.ship,this.playerGrid.wormhole.position);this.playerGrid.particles.createBankingBurst(this.playerGrid.wormhole.position,"#00ffff"),this.playerGrid.particles.createBurst(this.playerGrid.wormhole.position,this.getOrbColor(i),5,2,3,25),this.spawnAttackToRandomTarget("player",s),this.addKillFeed(`[UPLOAD] Slot ${t+1}: ${s.description}`)}handleBankOrbs(t,e){console.log(`[GAME HANDLEBANK] handleBankOrbs called by ${t}, orbs count=${e.length}`);const i=this.grids.get(t);if(!i){console.log(`[GAME HANDLEBANK] ERROR: sourceGrid not found for ${t}`);return}const s=X(e,i.ship,i.wormhole.position);console.log(`[GAME HANDLEBANK] Attack translated: tier=${s.tier}, desc="${s.description}", hazards=${s.hazards.length}`),this.spawnAttackToRandomTarget(t,s);const r=t==="player"?"Player":t.toUpperCase();this.addKillFeed(`${r} >> ${s.description}`)}spawnAttackToRandomTarget(t,e){console.log(`[GAME SPAWNFROM] spawnAttackToRandomTarget called, source=${t}`);const i=Array.from(this.grids.values()).filter(r=>r.owner!==t&&!r.ship.isDead);if(console.log(`[GAME SPAWNFROM] Living opponents: ${i.length} grids`),i.forEach(r=>console.log(`  - ${r.owner}, dead=${r.ship.isDead}`)),i.length===0){console.log("[GAME SPAWNFROM] ERROR: No living opponents to attack!");return}const s=i[Math.floor(Math.random()*i.length)];console.log(`[GAME SPAWNFROM] Targeting ${s.owner} with attack`),s.spawnAttack(e,t)}handleShipDestroyed(t){const e=Array.from(this.grids.values()).filter(i=>!i.ship.isDead);if(e.length===1){this.winner=e[0].owner,this.gameOver=!0;const i=this.winner==="player"?"Player":this.winner.toUpperCase();this.addKillFeed(`${i} WINS THE ROUND!`)}}addKillFeed(t){this.killFeed.unshift(t),this.killFeed.length>this.maxKillFeed&&this.killFeed.pop()}start(){this.running=!0,this.lastTime=performance.now(),requestAnimationFrame(this.loop.bind(this))}stop(){this.running=!1}loop(t){if(this.running){try{const e=t-this.lastTime;this.lastTime=t,this.frameCount++,t-this.lastFpsTime>=1e3&&(this.fps=this.frameCount,this.frameCount=0,this.lastFpsTime=t),this.accumulator+=e;const i=B*10;for(this.accumulator>i&&(this.accumulator=i);this.accumulator>=B;){this.sharedWormhole.update();for(const r of this.grids.values())r.update();for(const r of this.bots.values())r.update();this.updateBullets(),this.gameOver&&this.input.isActionPressed()&&this.restart(),this.accumulator-=B}const s=this.accumulator/B;this.render(s)}catch(e){console.error("GAME LOOP ERROR:",e),this.addKillFeed(`[ERROR] ${e instanceof Error?e.message:"Unknown error"}`)}requestAnimationFrame(this.loop.bind(this))}}updateBullets(){for(const i of this.bullets)i.update();const t=this.playerGrid.hazards,e=[];for(let i=this.bullets.length-1;i>=0;i--){const s=this.bullets[i];if(!s.active)continue;let r=!1;for(let o=t.length-1;o>=0;o--){const f=t[o];if(f.active&&s.collidesWith(f.position,f.radius)){r=!0,f.active=!1,e.push(f.id),this.playerGrid.particles.createBurst(f.position,"#ff6600",10,3,5,20),this.addKillFeed("[DEFENSE] Target destroyed!");break}}r&&(s.active=!1)}this.bullets=this.bullets.filter(i=>!i.isExpired()&&i.active),this.playerGrid.hazards=this.playerGrid.hazards.filter(i=>i.active)}render(t){const e=Array.from(this.grids.values());this.renderer.clear(),this.renderer.renderQuadrantView(e,this.playerGrid,this.bullets,t,this.fps,this.killFeed,this.gameOver,this.winner)}restart(){for(const t of this.grids.values())t.reset();for(const t of this.bots.values())t.reset();this.bullets=[],this.gameOver=!1,this.winner=null,this.killFeed=[],this.roundNumber++}destroy(){this.stop(),this.input.destroy()}getOrbColor(t){switch(t){case l.RED:return"#ff4444";case l.BLUE:return"#4444ff";case l.GREEN:return"#44ff44";case l.GOLD:return"#ffcc00";default:return"#ffffff"}}}document.addEventListener("DOMContentLoaded",()=>{try{console.log("WORMHOLE: Initializing game...");const a=new ee("gameCanvas");console.log("WORMHOLE: Game created, starting..."),a.start(),console.log("WORMHOLE: Game started successfully!"),window.addEventListener("beforeunload",()=>{a.destroy()})}catch(a){console.error("WORMHOLE: Failed to initialize:",a);const t=document.getElementById("gameCanvas");if(t){const e=t.getContext("2d");e&&(e.fillStyle="#ff0000",e.font="20px monospace",e.fillText("Error: "+a.message,50,100))}}});
